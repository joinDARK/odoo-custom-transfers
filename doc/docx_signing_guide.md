# Руководство по подписанию DOCX документов

## Обзор

Система подписания документов была обновлена для поддержки DOCX файлов в качестве исходных документов. Теперь пользователи могут загружать документы в формате DOCX, а подписанные документы будут автоматически конвертироваться в формат PDF.

## Поддерживаемые типы документов

- **Исходные документы**: DOCX и PDF
- **Подписанные документы**: PDF (всегда)

## Процесс работы

### 1. Загрузка документов

Загрузите DOCX или PDF файлы в соответствующие поля:
- `zayavka_attachments` - Заявка
- `invoice_attachments` - Инвойс  
- `assignment_attachments` - Поручение
- `swift_attachments` - SWIFT
- `swift103_attachments` - SWIFT 103
- `swift199_attachments` - SWIFT 199
- `report_attachments` - Акт-отчет

### 2. Обнаружение позиций подписей

После загрузки документа используйте соответствующую кнопку "Определить подписи":
- Для DOCX файлов: документ будет временно конвертирован в PDF для анализа
- Для PDF файлов: анализ выполняется напрямую
- Система найдет белый текст "Подпись" и "Печать" в документе
- Будут созданы позиции и назначения подписей

### 3. Назначение подписей

Назначьте подписи из библиотеки подписей на найденные позиции.

### 4. Подписание документа

При нажатии кнопки "Подписать":
- DOCX файл будет конвертирован в PDF
- На PDF будут наложены подписи в указанных позициях
- Подписанный PDF будет сохранен в соответствующем поле `signed_*_attachments`

## Технические требования

### Зависимости

1. **LibreOffice** - для конвертации DOCX в PDF
   ```bash
   # Ubuntu/Debian
   sudo apt-get install libreoffice
   
   # CentOS/RHEL
   sudo yum install libreoffice
   ```

2. **PyMuPDF** - для работы с PDF (уже используется)
   ```bash
   pip install pymupdf
   ```

### Поддерживаемые форматы

- **DOCX**: Microsoft Word документы (.docx)
- **PDF**: Portable Document Format (.pdf)

## Обработка ошибок

### Частые ошибки и решения

1. **"LibreOffice не найден"**
   - Установите LibreOffice на сервер
   - Убедитесь, что команда `libreoffice` доступна в PATH

2. **"Превышено время ожидания конвертации"**
   - Проверьте, что LibreOffice работает корректно
   - Уменьшите размер DOCX файла
   - Проверьте загрузку сервера

3. **"Неподдерживаемый тип файла"**
   - Загрузите файл в формате DOCX или PDF
   - Проверьте, что файл не поврежден

4. **"PyMuPDF не установлен"**
   - Установите библиотеку PyMuPDF
   - При отсутствии библиотеки система вернет исходный файл без подписей

## Примеры использования

### Подписание заявки

```python
# 1. Загрузить DOCX файл в zayavka_attachments
# 2. Выполнить обнаружение подписей
zayavka.action_detect_signatures_zayavka()

# 3. Назначить подписи (через интерфейс)
# 4. Подписать документ
zayavka.action_sign_zayavka()

# Результат: подписанный PDF в signed_zayavka_attachments
```

### Программное использование

```python
# Определение типа файла
file_type = zayavka._detect_file_type(file_data)

# Конвертация DOCX в PDF
if file_type == 'docx':
    pdf_data = zayavka._convert_docx_to_pdf(file_data)
```

## Логирование

Система записывает в лог следующие события:
- Успешное обнаружение подписей
- Ошибки конвертации DOCX в PDF
- Ошибки анализа документов
- Предупреждения о недоступности библиотек

Логи можно найти в стандартном логе Odoo с префиксом модуля `amanat`. 