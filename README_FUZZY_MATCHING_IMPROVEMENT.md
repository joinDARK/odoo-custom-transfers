# Улучшение алгоритма сопоставления плательщиков субагентов

## Описание проблемы

Ранее система использовала строгий алгоритм поиска соответствий между плательщиками субагентов в SWIFT документах и заявках, что приводило к ситуациям когда совпадения не находились из-за:
- Небольших опечаток в именах
- Различного порядка слов
- Сокращений и аббревиатур
- Лишних пробелов или знаков препинания

## Реализованные улучшения

### 1. Нечеткий поиск с множественными метриками

Новый алгоритм `_find_best_matching_zayavka_by_payer_name()` использует:

- **Строковое сходство (60% веса)**: алгоритм Ratcliff/Obershelp для вычисления сходства между строками
- **Пересечение токенов (40% веса)**: проверка совпадения отдельных слов между именами
- **Нормализация строк**: удаление знаков препинания, приведение к нижнему регистру, устранение лишних пробелов

### 2. Настраиваемый порог совпадения

Минимальный порог для принятия совпадения можно настроить через системные параметры:
```
amanat.swift_fuzzy_matching_threshold = 0.3 (по умолчанию)
```

### 3. Подробное логирование

Алгоритм выводит в лог:
- Топ-5 кандидатов с их скорами
- Детализацию по каждой метрике сходства
- Обоснование принятия или отклонения совпадений

### 4. Интерфейсные улучшения

- Кнопка "Тест нечеткого поиска" для проверки алгоритма
- Статус обработки в заголовке формы
- Поле с примечаниями об обработке

## Пример работы алгоритма

### Входные данные:
- SWIFT документ: плательщик "ООО Рога и Копыта"
- Заявка: плательщик "Рога и Копыта ООО"

### Старый алгоритм:
❌ Совпадение НЕ найдено (строгое сравнение)

### Новый алгоритм:
✅ Совпадение найдено со скором 0.85
- Строковое сходство: 0.82
- Пересечение токенов: 1.0 (все токены совпадают)
- Итоговый скор: 0.82 × 0.6 + 1.0 × 0.4 = 0.89

## Настройка параметров

Для изменения порога совпадения выполните:

```python
self.env['ir.config_parameter'].sudo().set_param(
    'amanat.swift_fuzzy_matching_threshold', '0.4'  # Более строгий порог
)
```

## Логи для отладки

Все операции нечеткого поиска логируются с префиксом `[SWIFT AUTO FUZZY]`:

```
[SWIFT AUTO FUZZY] Ищем ближайшее совпадение для плательщика: 'ООО Рога и Копыта'
[SWIFT AUTO FUZZY] Топ-1: Заявка 123, плательщик 'Рога и Копыта ООО', итоговый скор: 0.890
[SWIFT AUTO FUZZY] ✅ Лучшее совпадение найдено: заявка 123, скор: 0.890
```

## Производительность

Алгоритм оптимизирован для работы с большими объемами данных:
- Использует эффективные алгоритмы сравнения строк
- Минимизирует количество запросов к базе данных
- Кэширует результаты нормализации

## Обратная совместимость

Улучшенный алгоритм полностью заменяет старую логику поиска, но сохраняет все существующие проверки валюты, суммы и отсутствия SWIFT файлов.
