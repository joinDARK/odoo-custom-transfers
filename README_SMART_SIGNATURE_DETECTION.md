# Умное определение типа подписи для документов "Поручение"

## Описание
Система теперь автоматически определяет, какую подпись и печать использовать (ТДК или СТЕЛЛАР) на основе текста в PDF документе.

## Как работает

### 1. Загрузка документа
Пользователь загружает документ в поле "Поручение Вход" (`assignment_start_attachments`).

### 2. Анализ содержимого PDF
Система сканирует весь текст PDF документа и ищет ключевые слова:

**Для ТДК:**
- ТДК
- TDK
- тдк
- Тдк

**Для СТЕЛЛАР:**
- СТЕЛЛАР
- STELLAR
- стеллар
- Стеллар

### 3. Логика определения типа

#### Простые случаи:
- **Найдено только ТДК** → используется подпись и печать ТДК
- **Найдено только СТЕЛЛАР** → используется подпись и печать СТЕЛЛАР
- **Ничего не найдено** → используется СТЕЛЛАР по умолчанию

#### Сложный случай (найдены оба типа):
Система подсчитывает количество упоминаний каждого типа и выбирает тот, который встречается чаще.

### 4. Поиск подписей в библиотеке
Система ищет в "Библиотеке подписей" записи с соответствующими названиями:
- Для ТДК: ищет записи с названием содержащим "ТДК" или "TDK"
- Для СТЕЛЛАР: ищет записи с названием содержащим "СТЕЛЛАР" или "STELLAR"

### 5. Размещение подписи и печати
- **Подпись**: размещается ниже текста "Субагент/Subagent" (увеличена на 30%)
- **Печать**: размещается справа от подписи (стандартный размер)

## Требования к библиотеке подписей

Для корректной работы в "Библиотеке подписей" должны быть созданы записи:

### Для ТДК:
- **Подпись**: название содержит "ТДК" или "TDK", тип = "Подпись"
- **Печать**: название содержит "ТДК" или "TDK", тип = "Печать"

### Для СТЕЛЛАР:
- **Подпись**: название содержит "СТЕЛЛАР" или "STELLAR", тип = "Подпись"
- **Печать**: название содержит "СТЕЛЛАР" или "STELLAR", тип = "Печать"

## Логирование

Все действия записываются в логи с подробной информацией:

```
[_detect_signature_type_from_pdf] TDK found: True, STELLAR found: False
[auto_sign_assignment_start_with_stellar] Detected signature type: ТДК
[_find_signature_and_stamp_records] Found signature: ТДК Подпись
[_find_signature_and_stamp_records] Found stamp: ТДК Печать
```

## Примеры использования

### Пример 1: Документ с текстом "ТДК"
1. PDF содержит текст: "...подпись ТДК Субагент..."
2. Система определяет: тип = ТДК
3. Ищет в библиотеке подписей записи с "ТДК"
4. Размещает подпись и печать ТДК

### Пример 2: Документ с текстом "СТЕЛЛАР"
1. PDF содержит текст: "...подпись СТЕЛЛАР Субагент..."
2. Система определяет: тип = СТЕЛЛАР
3. Ищет в библиотеке подписей записи с "СТЕЛЛАР"
4. Размещает подпись и печать СТЕЛЛАР

### Пример 3: Документ без указания типа
1. PDF не содержит ключевых слов
2. Система использует СТЕЛЛАР по умолчанию
3. Размещает подпись и печать СТЕЛЛАР

## Безопасность и надежность

- ✅ Если подпись/печать не найдены в библиотеке - процесс останавливается с предупреждением
- ✅ При ошибках анализа PDF используется СТЕЛЛАР по умолчанию
- ✅ Детальное логирование для диагностики проблем
- ✅ Поиск нечувствителен к регистру символов

## Настройка

Для добавления новых типов подписей необходимо:
1. Создать записи в "Библиотеке подписей"
2. Добавить ключевые слова в метод `_detect_signature_type_from_pdf()`
3. Обновить логику в методе `_find_signature_and_stamp_records()`