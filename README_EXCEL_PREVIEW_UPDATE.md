# 🎉 Обновление превью Excel таблиц - Версия 3.2

## Что изменилось?

Превью Excel файлов теперь показывает **ОЧИЩЕННЫЕ ДАННЫЕ** без технических артефактов pandas - убраны колонки "Unnamed: 0" и значения "NaT"!

## ✨ Новые возможности версии 3.2

### 🧹 Очистка данных
- **Убраны колонки "Unnamed: 0"** и другие технические колонки pandas
- **Убраны значения "NaT"** (Not a Time) - заменены на пустые ячейки
- **Убраны значения "NaN"** - заменены на пустые ячейки 
- **Чистый вывод** без технических артефактов

### 📋 Оригинальные заголовки колонок (сохранено)
- **Настоящие названия колонок** из Excel файла (не буквы A, B, C...)
- **Полное соответствие** оригинальной структуре Excel
- **Сохранение форматирования** заголовков

### 📊 Полное отображение данных (сохранено)
- **Все строки** включая пустые (как в Excel)
- **Все колонки** без ограничений
- **Увеличенная высота** контейнера до 70% экрана (вместо 500px)
- **Увеличенные лимиты** чтения до 5000 строк (вместо 500)

### 🎨 Визуальные улучшения (сохранено)
- **Зеленый цвет заголовков** (#217346)
- **Sticky заголовки** остаются видимыми при прокрутке
- **Четкие границы** между ячейками
- **Плавные анимации** при появлении строк

## 🔧 Технические улучшения

### Backend изменения (models/ir_attachment.py)
- **Убраны колонки "Unnamed: 0"** и другие технические колонки
- **Замена NaT, NaN, null** на пустые значения
- **Убрана фильтрация пустых строк** в openpyxl методах
- **Увеличены лимиты** чтения с 500 до 5000 строк
- **Убраны ограничения** на превью (100 строк → без ограничений)
- **Убраны ограничения** на колонки (20 колонок → без ограничений)
- **Упрощены параметры** openpyxl для совместимости

### Frontend изменения  
- **Обработка NaT значений** в JavaScript коде
- **Сохранены оригинальные заголовки** вместо замены на буквы A, B, C...
- **Увеличена высота** контейнера с 500px до 70vh
- **Обновлены все JavaScript** модули для поддержки больших таблиц

## 📁 Измененные файлы

```
addons/amanat/models/ir_attachment.py              # Backend: очистка DataFrame + убрана фильтрация + увеличены лимиты
addons/amanat/static/src/css/attachment_preview.css    # CSS: увеличена высота контейнера
addons/amanat/static/src/js/attachment_preview.js       # JS: обработка NaT + сохранены оригинальные заголовки
addons/amanat/static/src/js/attachment_preview_modal.js # JS: обновлена высота модального окна
addons/amanat/static/src/js/sverka_files_preview.js     # JS: обработка NaT + сохранены оригинальные заголовки
addons/amanat/static/src/js/attachment_widget_extension.js # JS: обновлена высота контейнера
```

## 🎯 Результат

Теперь ваша таблица показывает **ЧИСТУЮ КОПИЮ Excel файла** без технических артефактов:

```
┌─────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│     │  Дата   │ Платеж  │ Валюта  │Плательщик│Получатель│  Курс   │    %    │К выдаче │ Выдано  │К выдаче │ Выдано  │
│     │         │         │         │         │         │         │         │  Рубли  │  Рубли  │ Доллары │ Доллары │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│  1  │04.03.2025│2 377 815│  RUB    │ СТЕЛЛАР │   ТДК   │    0    │   —     │2 377 815│   —     │   —     │   —     │
│     │         │   .81   │         │         │         │         │         │   .81   │         │         │         │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│  2  │ Итого:  │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│  3  │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│  4  │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│  5  │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ ... │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │   ...   │
├─────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ 15  │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │   —     │
└─────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
```

### 🌈 Ключевые особенности:
- **Чистые данные** без "Unnamed: 0", "NaT", "NaN" 
- **Оригинальные заголовки** ("Дата", "Платеж", "Валюта", "Плательщик", "Получатель", "Курс", "%", "К выдаче Рубли", "Выдано Рубли", "К выдаче Доллары", "Выдано Доллары")
- **Все строки** включая пустые (1, 2, 3... до 15+)
- **Все колонки** без ограничений
- **Зеленые заголовки** (#217346) как в Excel
- **Полная структура** как в оригинальном файле
- **Точное соответствие** Excel документу

## 🚀 Как использовать

После обновления все Excel таблицы автоматически будут отображать **ЧИСТУЮ КОПИЮ** оригинального файла без технических артефактов pandas. Никаких настроек не требуется!

## 🔧 Исправленные проблемы

### Проблема: Показывались технические колонки "Unnamed: 0" ✅ ИСПРАВЛЕНО
- **Была проблема:** Появлялись технические колонки pandas "Unnamed: 0", "Unnamed: 1" и т.д.
- **Что исправлено:** Автоматическое удаление всех колонок начинающихся с "Unnamed:"
- **Результат:** Чистый вывод без технических артефактов

### Проблема: Показывались значения "NaT" ✅ ИСПРАВЛЕНО
- **Была проблема:** В таблице отображались значения "NaT" (Not a Time)
- **Что исправлено:** Замена всех "NaT" на пустые ячейки с прочерком
- **Результат:** Чистый вывод как в Excel

### Проблема: Заголовки заменялись на буквы A, B, C... ✅ ИСПРАВЛЕНО
- **Была проблема:** Вместо реальных названий колонок показывались буквы A, B, C, D...
- **Что исправлено:** Теперь сохраняются оригинальные заголовки из Excel файла
- **Результат:** Точное соответствие структуре Excel документа

### Проблема: Показывались не все строки ✅ ИСПРАВЛЕНО
- **Была проблема:** Отображались только строки с данными (3 строки)
- **Что исправлено:** Теперь показываются все строки включая пустые
- **Результат:** Полная структура файла как в Excel

### Проблема: Ограничения на размер ✅ ИСПРАВЛЕНО
- **Была проблема:** Лимиты 100 строк, 20 колонок, 500px высота
- **Что исправлено:** Убраны все ограничения, высота 70% экрана
- **Результат:** Показываются все данные из файла

### Проблема: Совместимость с pandas ✅ ИСПРАВЛЕНО
- **Была проблема:** Ошибки с параметром `skip_blank_lines`
- **Что исправлено:** Убран неподдерживаемый параметр
- **Результат:** Стабильная работа со всеми версиями pandas

---

## Версия 3.3 - Улучшенная обработка формул Excel (Январь 2025)

### Что исправили:

1. **Обработка колонок "Unnamed: 0"**:
   - Теперь колонки не удаляются полностью
   - Заменяем названия "Unnamed: 0" на пустые строки
   - Сохраняем структуру данных как в Excel

2. **Улучшенная обработка формул Excel**:
   - Используем `data_only=False` для доступа к формулам
   - Получаем объекты Cell для проверки типа данных
   - Формулы отображаются как есть (например: `=SUM(A1:A10)`)
   - Pandas пытается получить вычисленные значения формул
   - Добавлена обработка ошибок формул (#N/A, #VALUE!, #REF!, #DIV/0!, etc.)

3. **Технические улучшения**:
   - Правильная обработка объектов Cell в openpyxl
   - Улучшенная очистка данных от артефактов
   - Добавлены дополнительные na_values для pandas

### Изменения в коде:

```python
# Обработка колонок "Unnamed: 0"
new_columns = []
for col in content.columns:
    if str(col).startswith('Unnamed:'):
        new_columns.append('')  # Пустая строка вместо удаления
    else:
        new_columns.append(col)
content.columns = new_columns

# Обработка формул
for cell in row_cells:
    if isinstance(cell.value, str) and cell.value.startswith('='):
        # Это формула - показываем её как есть
        clean_row.append(str(cell.value))
    else:
        # Обычное значение
        clean_row.append(str(cell.value))
```

### Файлы изменены:
- `models/ir_attachment.py` - основная логика обработки формул
- `README_EXCEL_PREVIEW_UPDATE.md` - обновлена документация

---

*Теперь ваши Excel файлы отображаются ИДЕАЛЬНО ЧИСТО как оригинал! 💚* 