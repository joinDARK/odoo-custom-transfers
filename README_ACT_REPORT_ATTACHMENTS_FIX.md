# Исправление проблем с полем act_report_attachments

## Проблемы, которые были исправлены:

### 1. **Файлы пропадают после загрузки и появляются только после перезагрузки страницы**
**Причина:** Поле `act_report_attachments` было определено как `One2many` с динамическим domain, что вызывало проблемы с кэшированием и отображением в интерфейсе.

**Решение:** Изменено поле на `Many2many`, как все остальные поля для файлов в модели.

### 2. **Нужно удалять документы дважды**
**Причина:** One2many поля имеют более сложную логику удаления, особенно с динамическими domain.

**Решение:** Many2many поля имеют стандартную логику удаления через промежуточную таблицу.

## Технические изменения:

### До:
```python
act_report_attachments = fields.One2many(
    'ir.attachment',
    'res_id',
    domain="[('res_model', '=', 'amanat.zayavka'), ('res_field', '=', 'act_report_attachments'), ('res_id', '=', id)]",
    string='Акт Отчет'
)
```

### После:
```python
act_report_attachments = fields.Many2many(
    'ir.attachment',
    'amanat_zayavka_act_report_attachment_rel',
    'zayavka_id',
    'attachment_id',
    string='Акт Отчет'
)
```

## Изменения в коде:

1. **Поле в модели** (`zayavka.py`):
   - Изменено с One2many на Many2many
   - Добавлена промежуточная таблица `amanat_zayavka_act_report_attachment_rel`

2. **Метод генерации** (`methods.py`):
   - Убрано установление `res_field` при создании attachment
   - Добавлено добавление файла в Many2many поле через команду `[(4, attachment.id)]`

3. **Метод write** (`methods.py`):
   - Упрощена логика обработки изменений поля
   - Убрана сложная логика поиска "потерянных" файлов

4. **Списки полей** (`zayavka.py`):
   - `act_report_attachments` перенесено из `one2many_fields` в `many2many_fields`

## Миграция данных:

Создан скрипт `migrate_act_report_attachments.py` для переноса существующих данных:
- Находит все файлы с `res_field = 'act_report_attachments'`
- Добавляет их в Many2many поле соответствующих заявок
- Очищает `res_field` у файлов

## Преимущества изменений:

1. **Стабильное отображение**: Файлы отображаются сразу после загрузки
2. **Простое удаление**: Файлы удаляются с первого раза
3. **Консистентность**: Все поля для файлов теперь работают одинаково
4. **Лучшая производительность**: Many2many поля работают быстрее с большим количеством файлов
5. **Упрощенный код**: Убрана сложная логика обработки One2many полей

## Совместимость:

- Все существующие файлы будут перенесены автоматически
- API для работы с полем остается тем же
- Интерфейс работает без изменений

