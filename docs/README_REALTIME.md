# Система Real-time обновлений Amanat

## Описание

Эта система обеспечивает мгновенные обновления данных без перезагрузки страницы, аналогично Airtable. Когда один пользователь изменяет данные, все остальные пользователи видят изменения в реальном времени.

## Архитектура

### Backend компоненты:

1. **AmanatBaseModel** (`models/base_model.py`) - базовая модель для всех финансовых таблиц
2. **res.users** дополнения (`models/res_users.py`) - методы для отправки уведомлений
3. **bus.bus** интеграция - для доставки сообщений через WebSocket

### Frontend компоненты:

1. **real_time_interaction.js** - основной JavaScript сервис
2. **CSS стили** - для подсветки изменений
3. **editing_state** сервис - для отслеживания конфликтов редактирования

## Поддерживаемые операции

- ✅ **CREATE** - создание новых записей
- ✅ **UPDATE** - обновление существующих записей  
- ✅ **DELETE** - удаление записей

## Поддерживаемые представления

- ✅ **List View** - полная поддержка с подсветкой изменений
- ✅ **Form View** - обновления с обработкой конфликтов
- ⚠️ **Kanban View** - базовая поддержка (перезагрузка)

## Интегрированные модели

Все модели, наследующие от `AmanatBaseModel`:

- ✅ **amanat.transfer** - переводы
- ✅ **amanat.money** - контейнеры денег  
- ✅ **amanat.order** - ордера
- ✅ **amanat.test.realtime** - тестовая модель
- ➕ И все остальные финансовые модели...

## Как использовать

### 1. Для пользователей

1. Откройте любую таблицу (например, Переводы)
2. Откройте ту же таблицу в другой вкладке/браузере
3. Измените данные в одной вкладке
4. Наблюдайте автоматическое обновление в другой вкладке

### 2. Для разработчиков

#### Добавление поддержки в новую модель:

```python
from .base_model import AmanatBaseModel

class MyModel(models.Model, AmanatBaseModel):
    _name = 'my.model'
    _inherit = ['amanat.base.model']
    
    def _get_realtime_fields(self):
        """Укажите поля для real-time обновлений"""
        return ['name', 'state', 'amount', 'partner_id']
```

#### Кастомизация уведомлений:

```python
# В любом методе модели
self._send_realtime_notification('update', changed_fields=['state'])
```

## Настройки

### Конфигурация каналов

Система использует канал `realtime_updates` для всех уведомлений.

### Фильтрация по пользователям

Система автоматически фильтрует уведомления:
- Пользователь не получает уведомления о своих изменениях
- Уведомления получают только пользователи, просматривающие ту же модель

## Тестирование

### Быстрый тест:

1. Перейдите в **Аманат > Тест Real-time**
2. Создайте несколько записей
3. Откройте список в двух вкладках
4. Измените данные в одной вкладке
5. Проверьте обновления в другой

### Тест конфликтов:

1. Откройте одну запись в Form View в двух вкладках
2. Начните редактировать в одной вкладке (не сохраняйте)
3. Сохраните изменения в другой вкладке
4. Система покажет уведомление о конфликте

## Возможные проблемы и решения

### Уведомления не приходят

1. Проверьте console в браузере на ошибки
2. Убедитесь, что bus_service работает
3. Проверьте, что пользователь имеет права на модель

### Подсветка не работает

1. Очистите кэш браузера
2. Проверьте загрузку CSS файлов
3. Убедитесь, что JavaScript сервис зарегистрирован

### Медленные обновления

1. Оптимизируйте `_get_realtime_fields()` - указывайте только нужные поля
2. Проверьте производительность computed полей
3. Рассмотрите использование индексов БД

## Расширенные возможности

### Пользовательские уведомления

```python
# Отправка кастомного уведомления
self.env.user._send_realtime_notification(
    'custom_action', 
    'my.model', 
    [{'id': self.id, 'message': 'Custom update'}],
    ['custom_field']
)
```

### Интеграция с другими модулями

Система спроектирована для легкой интеграции с внешними модулями. Просто наследуйте от `AmanatBaseModel`.

## Производительность

- **Память**: ~2MB на пользователя для JavaScript сервиса
- **Сеть**: ~1KB на уведомление
- **CPU**: Минимальное влияние на сервер
- **База данных**: Дополнительные запросы только при изменении данных

## Безопасность

- Уведомления фильтруются по правам доступа
- Передаются только разрешенные поля
- Many2one поля передаются как {id, display_name}
- Нет передачи чувствительных данных

## Логирование

Все real-time события логируются в:
- Browser console (для отладки)
- Odoo logs (для мониторинга)
- Activity модель (для аудита)

## Roadmap

- [ ] Поддержка Kanban drag&drop в real-time
- [ ] Групповые операции в real-time
- [ ] Оптимизация для больших таблиц (виртуализация)
- [ ] Поддержка real-time диаграмм и графиков
- [ ] Мобильная оптимизация

## Поддержка

Для вопросов и проблем:
1. Проверьте console браузера
2. Посмотрите логи Odoo  
3. Протестируйте на `amanat.test.realtime` модели
4. Обратитесь к команде разработки IncubeAI 