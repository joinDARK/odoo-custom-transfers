# Документация по модели `amanat.gold_deal`

## Описание
Модель `amanat.gold_deal` предназначена для учета сделок с золотом между контрагентами, с поддержкой мультивалютности, комиссий, автоматического создания ордеров, денежных движений и сверок, а также связей с заявками, ордерами и другими сущностями системы.

Эта модель наследуется от: `amanat.base.model`, `mail.thread`, `mail.activity.mixin`

## Поля
- **name** (`Char`): Номер (ID) сделки. Генерируется автоматически, только для чтения
- **status** (`Selection`): Статус (`Открыта`, `Архив`, `Закрыта`). По дефолту `Открыта`
- **comment** (`Char`): Комментарий к сделке
- **date** (`Date`): Дата
- **partner_ids** (`Many2many`): Партнеры. Связь с `amanat.partner_gold`
- **pure_weight_sum** (`Float`, вычисляемое): Чистый вес, гр (Rollup)
- **purchase_total_rub** (`Float`, вычисляемое): Общая сумма покупки
- **purchase_total_dollar** (`Float`, вычисляемое): Сумма закупа в долларах
- **expenses** (`Float`, вычисляемое): Расходы
- **service** (`Float`, вычисляемое): Услуга. Округляется до 3-х знаков после запятой
- **bank_sum** (`Float`, вычисляемое): Банк сумм. Округляется до 3-х знаков после запятой
- **bank_kb** (`Float`, вычисляемое): Банк КБ. Округляется до 3-х знаков после запятой
- **courier** (`Float`, вычисляемое): Курьер. Округляется до 3-х знаков после запятой
- **total_amount** (`Float`, вычисляемое): Общая сумма. Округляется до 3-х знаков после запятой
- **sale_amount_aed** (`Float`, вычисляемое): Сумма продажи AED.
- **sale_amount_usdt** (`Float`, вычисляемое): Сумма продажи USDT.
- **extra_expenses** (`Float`, вычисляемое): Дополнительные расходы.
- **final_rate** (`Float`, вычисляемое): Курс итог. Округляется до 3-х знаков после запятой
- **conduct_in** (`Boolean`): Провести вход
- **conduct_out** (`Boolean`): Провести выход
- **vita_posting** (`Boolean`): Проводка Вита
- **reconciliation** (`Boolean`): Сверка
- **reposting** (`Boolean`): Перепроводка
- **mark_for_deletion** (`Boolean`): Удалить
- **invoice_amount** (`Float`): Сумма по инвойсу
- **difference** (`Float`): Разница
- **bank** (`Selection`): Банк (`Вита`, `СКБ`, `Альфа`)
- **extract_delivery_ids** (`Many2many`): Платежка. Связь с `amanat.extract_delivery`
- **order_ids** (`Many2many`): Ордеры. Связь с `amanat.order`
- **buyer_id** (`Many2one`): Покупатель. Связь с `amanat.contragent`
- **hash_flag** (`Boolean`): Хэш
- **log_text** (`Text`): Лог обработки

## Методы
- **@api.depends('partner_ids.pure_weight') compute_pure_weight_sum** — Вычисляет сумму чистого веса по всем партнерам сделки.
- **@api.depends('partner_ids.amount_rub') compute_purchase_total_rub** — Вычисляет общую сумму покупки в рублях по всем партнерам сделки.
- **@api.depends('partner_ids.purchase_amount_dollar') compute_purchase_total_dollar** — Вычисляет общую сумму закупа в долларах по всем партнерам сделки.
- **@api.depends('partner_ids.total_expenses') compute_expenses** — Вычисляет общие расходы по всем партнерам сделки.
- **@api.depends('partner_ids.service_amount') compute_service** — Вычисляет сумму услуги по всем партнерам сделки.
- **@api.depends('partner_ids.bank_amount') compute_bank_sum** — Вычисляет сумму "Банк сумм" по всем партнерам сделки.
- **@api.depends('partner_ids.bank_kb_amount') compute_bank_kb** — Вычисляет сумму "Банк КБ" по всем партнерам сделки.
- **@api.depends('partner_ids.courier_amount') compute_courier** — Вычисляет сумму "Курьер" по всем партнерам сделки.
- **@api.depends('partner_ids.purchase_usdt') compute_total_amount** — Вычисляет общую сумму в USDT по всем партнерам сделки.
- **@api.depends('partner_ids.sale_amount_aed') compute_sale_amount_aed** — Вычисляет сумму продажи AED по всем партнерам сделки.
- **@api.depends('partner_ids.purchase_usdt') compute_sale_amount_usdt** — Вычисляет сумму продажи USDT по всем партнерам сделки. 
- **@api.depends('purchase_total_rub', 'total_amount') compute_final_rate** — Вычисляет итоговый курс как отношение общей суммы покупки к общей сумме.
- **@api.depends('purchase_total_rub', 'invoice_amount') compute_difference** — Вычисляет разницу между общей суммой покупки и суммой по инвойсу.
- **create_partner** — Создаёт нового партнера золота с датой текущей сделки и привязывает его к сделке.
- **@staticmethod prepare_currency_fields(currency_name, amount)** — Возвращает словарь с нужным полем суммы для указанной валюты.
- **@api.model create(vals)** — Переопределённый метод создания: автоматизирует обработку флагов "Провести вход", "Провести выход", "Удалить".
- **write(vals)** — Переопределённый метод записи: автоматизирует обработку флагов "Провести вход", "Провести выход", "Удалить", а также обработку платежки.
- **_action_delete** — Удаляет связанные ордера, денежные движения и сверки, очищает связи.
- **_append_log(message)** — Добавляет запись в лог сделки с московским временем, максимум 10 строк.
- **_action_process_gold_deal_input_logic** — Основная логика "Входа в сделку Золото": создание ордеров, денежных контейнеров и сверок для всех партнеров, а также финального ордера "Золото → Вита".
- **_action_process_gold_deal_output_logic** — Основная логика "Выхода из сделки Золото": создание ордера, денежных контейнеров и сверок для продажи золота покупателю.
- **_action_process_gold_deal_distribution_logic** — Распределяет суммы USDT по направлениям: услуга, банк сумм, банк КБ, курьер. Создаёт соответствующие ордера, денежные контейнеры и сверки.
- **_action_process_gold_deal_profit_distribution_logic** — Распределяет прибыль между партнерами, создаёт ордера, денежные контейнеры и сверки для каждого партнера.
- **@api.onchange('extract_delivery_ids') onchange_extract_delivery_ids** — При изменении платежки автоматически запускает обработку платежки.
- **_action_process_gold_deal_payment_logic** — Обрабатывает платежку: создаёт денежные контейнеры и сверки по всем ордерам, где контрагент 2 — "Вита".

### Важные детали
- Все автоматические действия (создание ордеров, распределение, удаление, обработка платежки) происходят при сохранении записи, если установлен соответствующий флаг.
- Если вы редактируете уже существующую сделку, повторное нажатие флага "Провести вход" или "Провести выход" пересоздаст ордера (старые будут удалены).
- Для корректной работы должны быть заведены все необходимые контрагенты, плательщики и кошельки. Если их нет — они будут созданы автоматически.
- При изменении поля "Платежка" (`extract_delivery_ids`) автоматически запускается обработка платежки и создаются соответствующие движения.
- Все вычисляемые поля (rollup/формулы) обновляются автоматически при изменении связанных данных.
- Для удаления сделки установите флаг "Удалить" (`mark_for_deletion`). После сохранения все связанные ордера, деньги и сверки будут удалены, а сделка переведена в архив.
- Все поля, кроме названий, должны отслеживаться в `chatter`.
- В лог сделки (`log_text`) автоматически добавляются ключевые события автоматизации (вход, выход, распределение и т.д.) с отметкой времени.
- Если в сделке нет партнеров или покупателя, автоматизация выдаст ошибку и не выполнит действия.
- При распределении USDT (услуга, банк сумм, банк КБ, курьер) создаются отдельные ордера и движения для каждого направления, если сумма по направлению указана.