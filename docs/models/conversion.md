# Документация по модели `amanat.conversion`

## Описание
Модель `amanat.conversion` предназначена для учета операций конвертации валют между контрагентами, с поддержкой роялти, кросс-курсов, автоматического создания ордеров, денежных движений и сверок.

Эта модель наследуется от: `amanat.base.model`, `mail.thread`, `mail.activity.mixin`

*P.S: также имеет `_logger` для сообщений и `CURRENCY_SELECTION`, где хранятся все валюты*

## Поля
- **name** (`Char`): Номер сделки. Генерируется автоматически, только для чтения
- **state** (`Selection`): Статус (`Открыта`, `Архив`, `Закрыта`). По дефолту `Открыта`
- **date** (`Date`): Дата конвертации. По дефолту - сегодняшняя дата при создании
- **amount** (`Float`): Сумма в исходной валюте. Округляется до 3-х знаков после запятой
- **currency** (`Selection`): Исходная валюта. По дефолту `RUB`
- **conversion_currency** (`Selection`): Валюта, в которую происходит конвертация. По дефолту `RUB`
- **rate** (`Float`): Курс конвертации. Округляется до 8-ми знаков после запятой
- **cross_envelope** (`Boolean`): Флаг кросс-конвертации
- **cross_rate** (`Float`): Кросс-курс. Округляется до 8-ми знаков после запятой
- **cross_conversion_currency** (`Selection`): Кросс-валюта (`RUB`, `USD`)
- **sender_id** (`Many2one`): Отправитель. Связь с `amanat.contragent`
- **sender_payer_id** (`Many2one`): Плательщик отправителя. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `sender_id` (контрагентом)
- **receiver_id** (`Many2one`): Получатель. Связь с `amanat.contragent`
- **receiver_payer_id** (`Many2one`): Плательщик получателя. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `receiver_id` (контрагентом)
- **wallet_id** (`Many2one`): Кошелек для конвертации. Связь с `amanat.wallet`
- **order_id** (`Many2many`): Связанные ордера. Связь с `amanat.order`
- **extract_delivery_ids** (`Many2many`): Связанные выписки. Связь с `amanat.extract_delivery`
- **contragent_count** (`Selection`): Количество контрагентов (1 или 2)
- **create_conversion** (`Boolean`): Флаг для создания ордера конвертации
- **delete_conversion** (`Boolean`): Флаг для удаления конвертации
- **make_royalty** (`Boolean`): Флаг для проведения роялти
- **royalty_recipient_1** (`Many2one`): Получатель роялти 1. Связь с `amanat.contragent`
- **royalty_percent_1** (`Float`): Процент роялти 1
- **royalty_amount_1** (`Float`, вычисляется): Сумма роялти 1
- **royalty_recipient_2** (`Many2one`): Получатель роялти 2. Связь с `amanat.contragent`
- **royalty_percent_2** (`Float`): Процент роялти 2
- **royalty_amount_2** (`Float`, вычисляется): Сумма роялти 2

## Методы
- **@api.onchange('sender_id') _onchange_sender_id** — Автоматически выбирает первого плательщика отправителя при изменении отправителя.
- **@api.onchange('receiver_id') _onchange_receiver_id** — Автоматически выбирает первого плательщика получателя при изменении получателя.
- **@api.onchange('contragent_count', 'sender_id', 'sender_payer_id') _onchange_contragent_count** — Синхронизирует получателя и его плательщика с отправителем, если выбран 1 контрагент.
- **@api.depends('amount', 'royalty_percent_1') _compute_royalty_amount_1** — Вычисляет сумму роялти 1 по формуле `amount * royalty_percent_1`.
- **@api.depends('amount', 'royalty_percent_2') _compute_royalty_amount_2** — Вычисляет сумму роялти 2 по формуле `amount * royalty_percent_2`.
- **@api.model create(vals)** — Переопределённый метод создания: подставляет кошелек «Конвертация», если не указан.
- **write(vals)** — Переопределённый метод записи: автоматизирует создание, удаление и проведение роялти по флагам.
- **_find_or_create_payer(name, contragent_id)** — Находит или создает плательщика по имени и контрагенту.
- **_clear_royalty_entries()** — Удаляет существующие записи роялти для текущего ордера.
- **_clear_orders_money_recon()** — Удаляет все связанные ордера, записи в Money и Reconciliation.
- **_create_conversion_order()** — Создаёт ордер конвертации и связанные записи, используется при нажатии на кнопку «Создать конвертацию».
- **_post_entries_for_order(order)** — Создаёт записи в `amanat.money` и `amanat.reconciliation` для указанного ордера.
- **_create_royalty_entries()** — Создаёт записи роялти на основе суммы роялти.
- **_currency_field_map(currency, amount)** — Возвращает словарь для валютных полей в Money и Reconciliation.
- **_convert_amount(amount, from_currency, to_currency, rate)** — Конвертирует сумму из одной валюты в другую с учетом направления.
- **action_delete_conversion()** — Удаляет конвертацию, связанные ордера, деньги и сверки, переводит запись в архив.

## Процесс заполнения
1. **Заполнение основных данных**
    - Укажите сумму, исходную валюту, валюту конвертации, курс, отправителя, получателя, плательщиков, кошелек.
    - Если требуется кросс-конвертация, заполните соответствующие поля (флаг, кросс-курс, кросс-валюта).
    - Если конвертация между одним и тем же контрагентом, выберите "1" в поле "Кол-во КА" — получатель и его плательщик будут синхронизированы с отправителем.
    - Если два контрагента — выберите "2" и укажите получателя и его плательщика вручную.
2. **Создание ордера конвертации**
    - Установите флаг **Создать конвертацию** (`create_conversion`).
    - После сохранения записи автоматически вызовется метод `_create_conversion_order`, который создаст ордер и связанные движения (Money, Reconciliation).
    - Все связанные записи будут созданы автоматически.
3. **Добавление и проведение роялти (если требуется)**
    - Заполните поля получателей роялти и проценты для каждого.
    - Установите флаг **Провести роялти** (`make_royalty`).
    - После сохранения записи автоматически вызовется метод `_create_royalty_entries`, который создаст отдельные движения для роялти.
4. **Удаление конвертации**
    - Для удаления установите флаг **Удалить конвертацию** (`delete_conversion`).
    - После сохранения все связанные ордера, деньги и сверки будут удалены, а запись переведена в архив.

### Важные детали
- Все автоматические действия (создание ордера, роялти, удаление) происходят при сохранении записи, если установлен соответствующий флаг.
- Если вы редактируете уже существующую конвертацию, повторное нажатие флага "Создать конвертацию" пересоздаст ордер (старые будут удалены).
- Роялти можно добавить как при создании конвертации, так и после — главное, чтобы были заполнены необходимые поля и установлен флаг.
- Для корректной работы должны быть заведены все необходимые контрагенты, плательщики и кошельки.
- Все поля, кроме названий, должны отслеживаться в `chatter`.