# Документация по модели `amanat.transfer`

## Описание
Модель `amanat.transfer` предназначена для учета переводов между контрагентами, с возможностью учета посредников, комиссий, роялти и автоматического создания связанных ордеров, денежных движений и сверок.

Эта модель наследуется от: `amanat.base.model`, `mail.thread`, `mail.activity.mixin`

## Поля
- **name** (`Char`): Номер заявки. Генерируется автоматически, только для чтения
- **state** (`Selection`): Статус (`Открыта`, `Архив`, `Закрыта`)
- **date** (`Date`): Дата перевода. По дефолту - сегодняшняя дата при создании
- **currency** (`Selection`): Валюта (`RUB`, `RUB КЭШ`, `USD`, `USD КЭШ`, `USDT`, `EURO`, `EURO КЭШ`, `CNY`, `CNY КЭШ`, `AED`, `AED КЭШ`, `THB`, `THB КЭШ`). RUB по дефолту
- **amount** (`Float`): Сумма перевода. Округляется до 3-х знаков после запятой
- **sender_id** (`Many2one`): Отправитель. Связь с `amanat.contragent`
- **sender_payer_id** (`Many2one`): Плательщик отправителя. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `sender_id` (контрагентом)
- **sender_wallet_id** (`Many2one`): Кошелек отправителя. Связь с `amanat.wallet`
- **receiver_id** (`Many2one`): Получатель. Связь с `amanat.contragent`
- **receiver_payer_id** (`Many2one`): Плательщик получателя. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `receiver_id` (контрагентом)
- **receiver_wallet_id** (`Many2one`): Кошелек получателя. Связь с `amanat.wallet`
- **is_complex** (`Boolean`): Сложный перевод. 
- **intermediary_1_id** (`Many2one`): Посредник 1. Связь с `amanat.contragent`
- **intermediary_1_payer_id** (`Many2one`): Плательщик посредника 1. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `intermediary_1_id` (контрагентом)
- **intermediary_1_wallet_id** (`Many2one`): Кошелек посредника 1. Связь с `amanat.wallet`
- **intermediary_1_sum** (`Float`, вычисляется): Сумма 1 посредника. Округляется до 2-х знаков после запятой.
- **intermediary_1_commission_percent** (`Float`): Процент комиссии посредника 1. Округляется до 2-х знаков после запятой.
- **intermediary_2_id** (`Many2one`): Посредник 2. Связь с `amanat.contragent`
- **intermediary_2_payer_id** (`Many2one`): Плательщик посредника 2. Связь с `amanat.payer`. Также имеет атрибут `domain` где в `amanat.payer.contragents_ids` (плательщиках) есть связанные c `intermediary_2_id` (контрагенты)
- **intermediary_2_wallet_id** (`Many2one`): Кошелек посредника 2. Связь с `amanat.wallet`
- **intermediary_2_sum** (`Float`, вычисляется): Сумма 2 посредника. Округляется до 2-х знаков после запятой.
- **intermediary_2_commission_percent** (`Float`): Процент комиссии посредника 2. Округляется до 2-х знаков после запятой.
- **sending_commission_percent** (`Float`): Общий процент комиссии за отправку. Округляется до 2-х знаков после запятой.
- **royalti_Transfer** (`Boolean`): Провести роялти.
- **royalty_percent_1** (`Float`): Процент роялти 1. Округляется до 2-х знаков после запятой.
- **royalty_percent_2** (`Float`): Процент роялти 2. Округляется до 2-х знаков после запятой.
- **royalty_percent_3** (`Float`): Процент роялти 3. Округляется до 2-х знаков после запятой.
- **royalty_percent_4** (`Float`): Процент роялти 4. Округляется до 2-х знаков после запятой.
- **royalty_percent_5** (`Float`): Процент роялти 5. Округляется до 2-х знаков после запятой.
- **royalty_recipient_1** (`Many2one`): Получатель роялти 1. Связь с `amanat.contragent`
- **royalty_recipient_2** (`Many2one`): Получатель роялти 2. Связь с `amanat.contragent`
- **royalty_recipient_3** (`Many2one`): Получатель роялти 3. Связь с `amanat.contragent`
- **royalty_recipient_4** (`Many2one`): Получатель роялти 4. Связь с `amanat.contragent`
- **royalty_recipient_5** (`Many2one`): Получатель роялти 5. Связь с `amanat.contragent`
- **order_ids** (`Many2many`): Связанные ордера. Связь с `amanat.order`
- **comment** (`Text`): Комментарии к переводу
- **manager_id** (`Many2one`): Менеджер. Связь с `res.users`
- **inspector_id** (`Many2one`): Инспектор. Связь с `res.users`
- **hash** (`Boolean`): Хеш
- **delete_Transfer** (`Boolean`): Удалить заявку
- **create_order** (`Boolean`): Создать ордера

## Методы
- **@api.onchange('sender_id') _onchange_sender_id** — Автоматически выбирает первого плательщика отправителя при изменении отправителя.
- **@api.onchange('receiver_id') _onchange_receiver_id** — Автоматически выбирает первого плательщика получателя при изменении получателя.
- **@api.onchange('intermediary_1_id') _onchange_intermediary_1_id** — Автоматически выбирает первого плательщика посредника 1 при изменении посредника 1.
- **@api.onchange('intermediary_2_id') _onchange_intermediary_2_id** — Автоматически выбирает первого плательщика второго посредника 2 при изменении посредника 2.
- **@api.depends('amount', 'intermediary_1_commission_percent') _compute_intermediary_1_sum** — Вычисляет сумму для первого посредника.
- **@api.depends('intermediary_1_sum', 'intermediary_2_commission_percent') _compute_intermediary_2_sum** — Вычисляет сумму для второго посредника.
- **create_transfer_orders** — Создаёт связанные ордера и денежные движения по сценарию (без посредников, с одним или двумя посредниками). Сначала используя метод `_delete_related_records`, а далее использует методы `_create_two_intermediary_transfer`, `_create_one_intermediary_transfer` и `_create_simple_transfer` в зависимости от кол-во посредников.
- **_create_simple_transfer(record)** — Создаёт ордер и движения для простого перевода (без посредников).
- **_create_one_intermediary_transfer(record)** — Создаёт ордера и движения для перевода с одним посредником.
- **_create_two_intermediary_transfer(record)** — Создаёт ордера и движения для перевода с двумя посредниками.
- **_create_money_and_reconciliation(order, wallet, partner, amount, sender_payer, receiver_payer)** — Создаёт записи в моделях amanat.money и amanat.reconciliation.
- **_get_currency_fields(currency, amount)** — Возвращает словарь с нужным полем суммы для валюты.
- **_calculate_amounts(amount, percent)** — Возвращает кортеж из двух сумм: до и после вычета процента.
- **write(vals)** — Переопределённый метод записи: автоматизирует удаление, создание и распределение роялти по флагам.
- **_delete_related_records** — Удаляет связанные ордера, деньги и сверки при удалении перевода.
- **_process_royalty_distribution** — Распределяет роялти между получателями, создаёт соответствующие ордера и движения.
- **@api.model create(vals)** — Переопределённый метод создания: подставляет "Неразмеченные" кошельки, автоматизирует создание ордеров.
- **_get_realtime_fields** — Возвращает список полей для real-time обновлений в списке переводов.

## Процесс заполнения
1. **Заполнение основных данных**
    - Укажите отправителя, получателя, сумму, валюту, плательщиков, кошельки и при необходимости — посредников (флаги, суммы, проценты).
    - Если перевод сложный (с посредниками), установите флаг **Сложный перевод** и заполните соответствующие поля для посредников.
2. **Создание ордеров**
    - Установите флаг Создать (create_order).
    - После сохранения записи автоматически вызовется метод `create_transfer_orders`, который создаст необходимые ордера и денежные движения по выбранному сценарию (без посредников, с одним или двумя посредниками).
    - Все связанные записи (ордера, деньги, сверки) будут созданы автоматически.
3. **Добавление и проведение роялти (если требуется)**
    - Заполните поля получателей роялти и проценты для каждого.
    - Установите флаг **Провести роялти** (`royalti_Transfer`).
    - После сохранения записи автоматически вызовется метод `_process_royalty_distribution`, который создаст отдельные ордера и движения для роялти.
4. **Удаление перевода**
    - Для удаления перевода установите флаг **Удалить заявку** (`delete_Transfer`).
    - После сохранения все связанные ордера, деньги и сверки будут удалены, а перевод переведен в архив.

### Важные детали
- Все автоматические действия (создание ордеров, роялти, удаление) происходят при сохранении записи, если установлен соответствующий флаг.
- Если вы редактируете уже существующий перевод, повторное нажатие флага Создать пересоздаст ордера (старые будут удалены).
- Роялти можно добавить как при создании перевода, так и после создания — главное, чтобы были заполнены необходимые поля и установлен флаг.
- Для корректной работы должны быть заведены все необходимые контрагенты, плательщики и кошельки.
- Все поля, кроме названий, должны отслеживаться в `chatter`.