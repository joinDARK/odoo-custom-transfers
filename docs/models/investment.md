# Документация по модели `amanat.investment`

## Описание
Модель `amanat.investment` предназначена для учета инвестиций между контрагентами с поддержкой мультивалютности, автоматического создания ордеров, начисления процентов и роялти, списаний, сверок, а также гибкой автоматизации (создание, проведение, закрытие, удаление, начисление процентов и роялти).

Эта модель наследуется от: `amanat.base.model`, `mail.thread`, `mail.activity.mixin`

## Поля
- **name** (`Char`): ID инвестиции. Генерируется автоматически, только для чтения.
- **status** (`Selection`): Статус (`Открыта`, `Закрыта`, `Архив`). По умолчанию — `Открыта`.
- **date** (`Date`): Дата открытия инвестиции. По умолчанию — сегодняшняя дата.
- **date_close** (`Date`): Дата закрытия инвестиции.
- **sender** (`Many2one`): Отправитель. Связь с `amanat.contragent`.
- **payer_sender** (`Many2one`): Плательщик отправителя. Связь с `amanat.payer`. Автоматически подбирается по отправителю.
- **receiver** (`Many2one`): Получатель. Связь с `amanat.contragent`.
- **payer_receiver** (`Many2one`): Плательщик получателя. Связь с `amanat.payer`. Автоматически подбирается по получателю.
- **percent** (`Float`): Процент по инвестиции.
- **fixed_amount** (`Float`): Фиксированная сумма процентов.
- **period** (`Selection`): Период начисления (`Календарный день`, `Календарный месяц`, `Календарный год`, `Рабочий день`).
- **amount** (`Float`): Сумма инвестиции.
- **currency** (`Selection`): Валюта (`RUB`, `RUB КЭШ`, `USD`, `USD КЭШ`, `USDT`, `EURO`, `EURO КЭШ`, `CNY`, `CNY КЭШ`, `AED`, `AED КЭШ`, `THB`, `THB КЭШ`).
- **create_action** (`Boolean`): Флаг для автоматического создания ордеров и контейнеров.
- **to_delete** (`Boolean`): Флаг для удаления инвестиции.
- **post** (`Boolean`): Флаг для проведения инвестиции (создание сверок).
- **close_investment** (`Boolean`): Флаг для закрытия инвестиции.
- **accrue** (`Boolean`): Флаг для начисления процентов и роялти вручную.
- **has_royalty** (`Boolean`): Есть ли роялти.
- **royalty_post** (`Boolean`): Флаг для создания роялти.
- **royalty_recipient_1..9** (`Many2one`): Получатели роялти 1-9. Связь с `amanat.contragent`.
- **percent_1..9** (`Float`): Проценты роялти для каждого получателя.
- **orders** (`Many2many`): Связанные ордера. Связь с `amanat.order`.
- **write_offs** (`Many2many`): Связанные списания. Связь с `amanat.writeoff`.
- **write_offs_preview** (`Many2many`, вычисляется): Первые 10 списаний для предпросмотра.
- **principal** (`Float`, вычисляется): Тело долга (остаток по инвестиции).
- **calendar_days** (`Integer`, вычисляется): Количество календарных дней с даты открытия.
- **work_days** (`Integer`, вычисляется): Количество рабочих дней с даты открытия.
- **today_date** (`Date`, вычисляется): Текущая дата.
- **rollup_write_offs** (`Float`, вычисляется): Сумма всех списаний по связанным ордерам.
- **rollup_amount** (`Float`): Сумма роллап списания.
- **rollup_amount_total** (`Float`): Сумма RollUp (from Погасить).
- **royalty_amount_1..9** (`Float`, вычисляется): Суммы роялти для каждого получателя.

## Методы
- **@api.onchange('sender') _onchange_sender** — Автоматически выбирает первого плательщика отправителя при изменении отправителя.
- **@api.onchange('receiver') _onchange_receiver** — Автоматически выбирает первого плательщика получателя при изменении получателя.
- **action_create_writeoff** — Открывает форму создания списания по инвестиции.
- **@api.depends('amount', 'rollup_write_offs') _compute_principal** — Вычисляет тело долга.
- **@api.depends('date') _compute_calendar_and_work_days** — Вычисляет календарные и рабочие дни, а также сегодняшнюю дату.
- **@api.depends('orders.rollup_write_off') _compute_rollup_write_offs** — Считает сумму всех списаний по ордерам.
- **@api.depends('amount', 'percent_1..9') _compute_royalty_amounts** — Вычисляет суммы роялти для каждого получателя.
- **action_create_writeoffs** — Создаёт помесячные списания по principal за прошедшие месяцы.
- **action_post** — Проводит инвестицию: синхронизирует сверки.
- **action_sync_reconciliation** — Полная автоматизация сверок: удаляет старые, создает новые по процентам, роялти и principal.
- **action_sync_airtable** — Полная автоматизация: удаляет старые ордера, создает новые, контейнеры, роялти, сверки.
- **action_delete** — Удаляет все связанные ордера, деньги, сверки, переводит инвестицию в архив.
- **action_close_investment** — Закрывает инвестицию: создает финальные списания и долговые контейнеры.
- **action_create_royalty_containers** — Создаёт контейнеры роялти для всех заполненных получателей.
- **accrue_interest** — Ежедневное начисление процентов и роялти по открытым инвестициям (используется в кроне и вручную).
- **_cron_accrue_interest** — Крон-метод для ежедневного начисления процентов.
- **write(vals)** — Переопределённый метод записи: автоматизирует обработку флагов (создать, удалить, провести, закрыть, начислить).
- **create(vals)** — Переопределённый метод создания: автоматизирует обработку флагов (создать, удалить, закрыть, начислить).
- **action_update_rollup_amount** — Пересчитывает сумму rollup_amount.
- **button_update_rollup_amount** — Кнопка для ручного обновления rollup_amount.
- **test_moscow_time_logic** — Тестовый метод для проверки логики времени по Москве.
- **action_show_all_writeoffs** — Открывает act_window со всеми списаниями по инвестиции.

## Процесс заполнения
1. **Заполнение основных данных**
    - Укажите отправителя, получателя, сумму, валюту, плательщиков, период, процент или фиксированную сумму, а также получателей роялти и проценты (если требуется).
2. **Создание инвестиции**
    - Установите флаг **Создать** (`create_action`).
    - После сохранения автоматически вызовется метод `action_sync_airtable`, который создаст ордера, контейнеры, роялти и сверки.
3. **Проведение инвестиции**
    - Установите флаг **Провести** (`post`).
    - После сохранения автоматически вызовется метод `action_post`, который синхронизирует сверки.
4. **Начисление процентов и роялти**
    - Установите флаг **Начислить** (`accrue`).
    - После сохранения автоматически вызовется метод `accrue_interest`, который создаст списания процентов и роялти за все дни с даты открытия.
5. **Закрытие инвестиции**
    - Установите флаг **Закрытие инвестиций** (`close_investment`).
    - После сохранения автоматически вызовется метод `action_close_investment`, который создаст финальные списания и долговые контейнеры, а также изменит статус и дату закрытия.
6. **Удаление инвестиции**
    - Установите флаг **Удалить** (`to_delete`).
    - После сохранения автоматически вызовется метод `action_delete`, который удалит все связанные ордера, деньги, сверки и переведет инвестицию в архив.

## Важные детали
- Все автоматические действия (создание ордеров, начисление процентов, роялти, удаление, проведение, закрытие) происходят при установке соответствующего флага и сохранении записи.
- Все вычисляемые поля (тело долга, дни, суммы роялти, rollup) обновляются автоматически при изменении связанных данных.
- Для корректной работы должны быть заведены все необходимые контрагенты, плательщики, кошельки.
- При изменении отправителя/получателя плательщики подбираются автоматически.
- Для начисления процентов и роялти используется московское время: если сейчас до 20:00, начисление идет до вчерашнего дня.
- Все поля, кроме названия, должны отслеживаться в `chatter`.
- При удалении инвестиции все связанные сущности (ордера, деньги, сверки) также удаляются, а статус переводится в архив. 