# Инструкция по тестированию сохранения состояния поиска

## ✅ ИСПРАВЛЕНО: Ошибка загрузки модуля

**Проблема была решена** созданием простой и надежной реализации на основе DOM событий вместо патчинга SearchModel.

## Быстрое тестирование

### 1. Перезапустите Odoo
```bash
# В терминале в корне проекта
./odoo-bin -d your_database_name -u amanat
```

### 2. Базовый тест функционала

1. **Откройте "Заявки"**
   - Введите в поле "№ заявки": `2024`
   - Включите фильтр "Активные заявки"

2. **Перейдите в "Контрагенты"**
   - Введите в поиск: `ООО`
   - Включите фильтр "С плательщиками"

3. **Вернитесь в "Заявки"**
   - ✅ Поле "№ заявки" должно содержать `2024`
   - ✅ Фильтр "Активные заявки" должен быть включен

4. **Вернитесь в "Контрагенты"**
   - ✅ Поиск должен содержать `ООО`
   - ✅ Фильтр "С плательщиками" должен быть включен

## Отладка через консоль

Откройте консоль разработчика (F12) и выполните:

### Проверить состояние функционала:
```javascript
// Проверить включен ли функционал
AmanatSearchState.config.enabled

// Посмотреть статистику сохраненных состояний
AmanatSearchState.stats()

// Посмотреть текущее состояние для конкретной модели
AmanatSearchState.utils.getAllStates()
```

### Управление функционалом:
```javascript
// Включить отладочные логи
AmanatSearchState.debug()

// Очистить все сохраненные состояния
AmanatSearchState.clear()

// Отключить функционал (если мешает)
AmanatSearchState.disable()

// Включить обратно
AmanatSearchState.enable()
```

## Расширенное тестирование

### Тест 1: Множественные поля поиска
1. Откройте "Заявки"
2. Заполните несколько полей одновременно:
   - № заявки: `2024`
   - Сумма заявки: `1000000`
   - Выберите контрагента
3. Перейдите в другое меню и вернитесь
4. Проверьте, что все поля сохранились

### Тест 2: Комбинация фильтров и группировок
1. Откройте "Контрагенты"
2. Включите несколько фильтров:
   - "С плательщиками"
   - "Постоплата"
3. Выберите группировку "По условиям работы"
4. Перейдите в другое меню и вернитесь
5. Проверьте, что фильтры и группировка сохранились

### Тест 3: Время жизни состояний
1. Выполните поиск в любой модели
2. В консоли выполните:
```javascript
// Получить все состояния и посмотреть timestamp
let states = AmanatSearchState.utils.getAllStates();
console.log(states);

// Искусственно состарить состояние (для теста)
let key = Object.keys(states)[0];
let state = states[key];
state.timestamp = Date.now() - (25 * 60 * 60 * 1000); // 25 часов назад
localStorage.setItem('amanat_search_state_' + key, JSON.stringify(state));
```
3. Перезагрузите страницу
4. Состояние должно быть автоматически очищено

## Устранение проблем

### Если состояние не сохраняется:

1. **Проверьте консоль на ошибки:**
```javascript
// Должно быть true
AmanatSearchState.config.enabled

// Должны быть логи при включенной отладке
AmanatSearchState.debug()
```

2. **Проверьте localStorage браузера:**
   - F12 → Application → Local Storage
   - Найдите ключи начинающиеся с `amanat_search_state_`

3. **Проверьте модель в списке разрешенных:**
```javascript
// Посмотреть список разрешенных моделей
AmanatSearchState.config.enabledModels

// Проверить конкретную модель
AmanatSearchState.config.isEnabledForModel('amanat.zayavka')
```

### Если состояние не восстанавливается:

1. **Очистите все состояния и попробуйте снова:**
```javascript
AmanatSearchState.clear()
```

2. **Проверьте структуру DOM:**
   - Убедитесь, что поля поиска имеют атрибут `name`
   - Проверьте селекторы в консоли:
```javascript
document.querySelectorAll('.o_searchview input, .o_searchview select')
```

## Известные ограничения

1. **Групповые фильтры** - пока не полностью поддерживаются
2. **Пользовательские виджеты** - могут требовать дополнительной настройки  
3. **Быстрые переходы** - состояние сохраняется с задержкой 500ms

## Настройка под ваши нужды

Отредактируйте файл `static/src/js/search_state_config.js`:

```javascript
// Добавить свою модель
enabledModels: [
    "amanat.zayavka",
    "your.custom.model",  // <-- добавить здесь
]

// Исключить поле из сохранения
excludeFields: [
    "password",
    "your_secret_field",  // <-- добавить здесь
]

// Изменить время жизни (в миллисекундах)
maxAge: 48 * 60 * 60 * 1000,  // 48 часов вместо 24
```

## Обратная связь

Если что-то не работает:

1. Включите отладку: `AmanatSearchState.debug()`
2. Выполните действие, которое не работает
3. Скопируйте логи из консоли
4. Проверьте содержимое localStorage
5. Опишите проблему с подробностями


