# Руководство по подписанию документов в модуле Amanat

## Обзор

Модуль Amanat теперь поддерживает автоматическое подписание документов с использованием библиотеки подписей. Функционал позволяет:

1. Загружать PDF шаблоны документов с белыми текстами "Подпись" и "Печать"
2. Автоматически находить позиции для подписей
3. Назначать подписи из библиотеки на найденные позиции
4. Генерировать подписанные документы

## Поддерживаемые типы документов

- **Заявка** (`zayavka_file`)
- **Инвойс** (`invoice_file`) 
- **Поручение** (`assignment_file`)
- **SWIFT** (`swift_file`)
- **SWIFT 103** (`swift103_file`)
- **SWIFT 199** (`swift199_file`)
- **Акт-отчет** (`report_file`)

## Процесс подписания документов

### Шаг 1: Подготовка шаблона документа

1. Создайте PDF документ с белым текстом "Подпись" и "Печать" в местах, где должны быть подписи
2. Убедитесь, что текст действительно белый (RGB близко к 255,255,255)
3. Сохраните документ в формате PDF

### Шаг 2: Загрузка документа

1. Откройте заявку в Odoo
2. Перейдите на вкладку "Документы"
3. Загрузите PDF файл в соответствующее поле (например, `zayavka_file`)

### Шаг 3: Определение сигнатур

1. После загрузки файла нажмите кнопку "Определить сигнатуры" рядом с соответствующим полем
2. Система автоматически найдет все белые тексты "Подпись" и "Печать"
3. Для каждого найденного текста будет создана позиция подписи
4. Статус документа изменится на "Готов к подписанию"

### Шаг 4: Назначение подписей

1. Останьтесь на вкладке "Документы"
2. После определения сигнатур появится раздел "Назначения подписей" под соответствующим документом
3. В этом разделе для каждой позиции выберите подпись из библиотеки
4. Убедитесь, что тип подписи соответствует типу позиции (подпись/печать)

### Шаг 5: Подписание документа

1. После назначения всех необходимых подписей нажмите кнопку "Подписать" рядом с соответствующим документом
2. Система сгенерирует подписанный PDF и сохранит его в поле `signed_*_file`
3. Статус документа изменится на "Подписан"
4. Подписанный файл появится в третьей колонке под документом

## Библиотека подписей

### Создание подписи/печати

1. Перейдите в меню "Библиотека подписей"
2. Создайте новую запись
3. Укажите название, тип (Подпись/Печать) и загрузите изображение
4. Установите размеры по умолчанию (опционально)

### Типы подписей

- **Подпись** - для личных подписей
- **Печать** - для печатей организации

## Технические модели

### AmanatZayavkaSignaturePosition
Хранит информацию о позициях подписей в документе:
- `name` - название позиции
- `zayavka_id` - ссылка на заявку
- `document_type` - тип документа
- `page_number` - номер страницы
- `x_position`, `y_position` - координаты
- `width`, `height` - размеры области
- `signature_type` - тип подписи (подпись/печать)
- `required` - обязательность заполнения

### AmanatZayavkaSignatureAssignment
Связывает позиции подписей с конкретными подписями из библиотеки:
- `name` - название назначения
- `zayavka_id` - ссылка на заявку
- `position_id` - ссылка на позицию
- `document_type` - тип документа
- `signature_id` - ссылка на подпись из библиотеки

## Методы API

### Определение подписей
- `action_detect_signatures_zayavka()`
- `action_detect_signatures_invoice()`
- `action_detect_signatures_assignment()`
- `action_detect_signatures_swift()`
- `action_detect_signatures_swift103()`
- `action_detect_signatures_swift199()`
- `action_detect_signatures_report()`

### Подписание документов
- `action_sign_zayavka()`
- `action_sign_invoice()`
- `action_sign_assignment()`
- `action_sign_swift()`
- `action_sign_swift103()`
- `action_sign_swift199()`
- `action_sign_report()`

## Требования

- PyMuPDF (для обработки PDF)
- Модуль document_signature (для базового функционала)

## Устранение неполадок

### Подписи не найдены
1. Проверьте, что текст действительно белый
2. Убедитесь, что используются точные слова "Подпись" и "Печать"
3. Проверьте, что PyMuPDF установлен

### Ошибка при подписании
1. Убедитесь, что все обязательные позиции имеют назначенные подписи
2. Проверьте соответствие типов подписей и позиций
3. Убедитесь, что исходный PDF файл корректный

### Некорректное позиционирование подписи
1. Проверьте размеры подписи в библиотеке
2. При необходимости отредактируйте координаты позиции вручную 