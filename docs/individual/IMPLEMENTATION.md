# Детали реализации генерации документа "Индивидуал"

## Архитектура решения

### Основные компоненты

1. **Контроллер генерации** (`action_generate_individual_document`)
2. **Подготовка данных** (`_prepare_individual_template_data`)
3. **Сервис перевода** (`_translate_text_via_yandex_gpt`)
4. **Конвертер PDF** (`_convert_docx_to_pdf_base64`)
5. **Пользовательский интерфейс** (кнопки в форме заявки)

## Подробное описание методов

### 1. action_generate_individual_document()

**Назначение:** Основной метод генерации документа

**Параметры:**
- Получает `output_format` из контекста ('docx' или 'pdf')

**Алгоритм работы:**
```python
1. Получение формата из контекста
2. Поиск шаблона "Индивидуал" в библиотеке шаблонов
3. Подготовка данных для подстановки
4. Генерация DOCX документа
5. Конвертация в PDF (при необходимости)
6. Создание attachment и сохранение в assignment_end_attachments
7. Возврат результата пользователю
```

**Обработка ошибок:**
- Проверка наличия шаблона
- Валидация результата генерации
- Обработка ошибок конвертации в PDF

### 2. _prepare_individual_template_data()

**Назначение:** Подготовка данных для подстановки в шаблон

**Возвращает:** Словарь с сигнатурами и соответствующими значениями

**Ключевые функции:**
- `format_russian_date()` - форматирование дат в русском стиле
- `format_english_date()` - форматирование дат в английском стиле

**Форматы дат:**
- Русский: `«18» Августа 2025`
- Английский: `August 18, 2025`

**Обработка полей:**
```python
# Простые поля
instruction_number = self.instruction_number or ""

# Поля с форматированием
amount = f"{self.amount:.2f}" if self.amount else "0.00"
currency = str(self.currency).upper() if self.currency else ""

# Поля с переводом
agent_name_en = self._translate_text_via_yandex_gpt(agent_name_ru)
```

### 3. _translate_text_via_yandex_gpt()

**Назначение:** Перевод текста с русского на английский через YandexGPT

**Параметры:**
- `text` (str) - текст для перевода

**Возвращает:** Переведенный текст или оригинал при ошибке

**Промпт для перевода:**
```
Переведи следующий текст с русского языка на английский язык. 
Это название организации или компании, поэтому перевод должен быть профессиональным и точным.
Если это юридическое лицо (ООО, АО и т.д.), переведи правильно юридическую форму.
Верни только переведенный текст без дополнительных комментариев.

Текст для перевода: {text}
```

**Примеры переводов:**
- `ООО "Импекс-Ф"` → `Implex-F LLC`
- `АО "Банк Развития"` → `Development Bank JSC`
- `ИП Иванов И.И.` → `Ivanov I.I. Individual Entrepreneur`

### 4. _convert_docx_to_pdf_base64()

**Назначение:** Конвертация DOCX в PDF с использованием LibreOffice

**Параметры:**
- `docx_base64` (str) - DOCX файл в формате base64

**Возвращает:** PDF файл в формате base64 или None при ошибке

**Алгоритм:**
1. Декодирование base64 в байты
2. Использование существующей функции `_convert_docx_to_pdf()`
3. Возврат результата в base64

## Интеграция с существующей системой

### Использование существующих компонентов

1. **Библиотека шаблонов** (`template.library`)
   - Поиск шаблона по имени "Индивидуал"
   - Увеличение счетчика использования

2. **Система генерации документов**
   - Использование `_generate_document_from_template()`
   - Совместимость с существующей логикой замены сигнатур

3. **YandexGPT интеграция**
   - Использование `_send_text_to_yandex_gpt_with_prompt()`
   - Получение конфигурации через `_get_yandex_gpt_config()`

4. **Конвертация в PDF**
   - Использование существующей `_convert_docx_to_pdf()`
   - Поддержка LibreOffice headless режима

### Сигнатуры в шаблоне

Система работает с двойными фигурными скобками `{{сигнатура}}`:

```python
template_data = {
    '{{номер_п}}': instruction_number,
    '{{подписан_а_с}}': agent_contract_date_formatted,
    '{{подписано_п}}': instruction_signed_date_ru,
    '{{order_s}}': instruction_signed_date_en,
    '{{агент}}': agent_name_ru,
    '{{agent}}': agent_name_en,
    '{{клиент}}': client_name_ru,
    '{{client}}': client_name_en,
    # ... остальные поля
}
```

### Обработка таблиц

Система использует существующую логику обработки DOCX:
- Сохранение структуры таблиц
- Точная замена сигнатур без повреждения форматирования
- Поддержка многоколоночных таблиц (русский/английский)

## Конфигурация

### Шаблон в библиотеке

```xml
<record id="demo_template_individual_docx" model="template.library">
    <field name="name">Индивидуал</field>
    <field name="template_type">docx</field>
    <field name="category">other</field>
    <field name="template_filename">Индивидуал.docx</field>
    <field name="description">Шаблон индивидуального поручения</field>
    <field name="template_file" type="base64" file="amanat/static/src/template_documents/Индивидуал.docx"/>
</record>
```

### Интерфейс пользователя

```xml
<div class="o_inner_group d-flex gap-2 mt-2">
    <button name="action_generate_individual_document" type="object"
        string="Генерировать Индивидуал (DOCX)" class="btn-success"
        context="{'output_format': 'docx'}" />
    <button name="action_generate_individual_document" type="object"
        string="Генерировать Индивидуал (PDF)" class="btn-info"
        context="{'output_format': 'pdf'}" />
</div>
```

## Производительность и оптимизация

### Кэширование переводов
- Переводы не кэшируются для обеспечения актуальности
- При ошибке перевода возвращается оригинальный текст

### Обработка больших документов
- Использование временных файлов для конвертации
- Автоматическая очистка временных файлов
- Таймауты для предотвращения зависания

### Логирование производительности
```python
_logger.info(f"=== ГЕНЕРАЦИЯ ДОКУМЕНТА ИНДИВИДУАЛ ДЛЯ ЗАЯВКИ ID {self.id} ===")
_logger.info(f"Формат вывода: {output_format}")
_logger.info(f"[ПЕРЕВОД] '{text}' -> '{result}'")
```

## Безопасность

### Валидация входных данных
- Проверка существования полей модели
- Обработка пустых и None значений
- Экранирование специальных символов

### Обработка ошибок YandexGPT
- Fallback к оригинальному тексту
- Логирование ошибок без раскрытия API ключей
- Таймауты для предотвращения блокировки

### Права доступа
- Использование существующих групп безопасности
- Проверка прав на создание attachments
- Аудит операций через стандартное логирование Odoo
