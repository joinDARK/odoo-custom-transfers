# Генерация документа "Индивидуал"

## Описание

Модуль генерации документа "Индивидуал" предназначен для автоматического создания индивидуальных поручений на основе данных заявки с использованием YandexGPT для переводов названий организаций.

## Основные возможности

- ✅ Генерация документов в форматах DOCX и PDF
- ✅ Автоматический перевод названий агента и клиента с русского на английский через YandexGPT
- ✅ Форматирование дат в русском и английском форматах
- ✅ Сохранение структуры таблиц в шаблоне
- ✅ Точная замена сигнатур без повреждения других частей текста
- ✅ Автоматическое сохранение в поле "поручение выход"

## Структура файлов

```
docs/individual/
├── README.md                    # Основная документация
├── IMPLEMENTATION.md            # Детали реализации
├── FIELD_MAPPING.md            # Сопоставление полей
├── YANDEX_GPT_INTEGRATION.md   # Интеграция с YandexGPT
└── USER_GUIDE.md               # Руководство пользователя
```

## Быстрый старт

### 1. Настройка YandexGPT
Убедитесь, что в системе настроены параметры YandexGPT:
- `amanat.ygpt.api_key` - API ключ YandexGPT
- `amanat.ygpt.folder_id` - Folder ID в Yandex Cloud

### 2. Использование
1. Откройте заявку в Odoo
2. Перейдите на вкладку "Документы"
3. Найдите поле "assignment_end_attachments" (поручение выход)
4. Нажмите одну из кнопок:
   - "Генерировать Индивидуал (DOCX)" - для создания Word документа
   - "Генерировать Индивидуал (PDF)" - для создания PDF документа

### 3. Результат
Сгенерированный документ автоматически сохранится в поле "поручение выход" и будет доступен для скачивания.

## Требования

- Odoo 18.0+
- Настроенная интеграция с YandexGPT
- Шаблон "Индивидуал.docx" в библиотеке шаблонов
- LibreOffice (для конвертации в PDF)

## Поддерживаемые поля

Документ заполняется следующими данными из заявки:

| Поле в документе | Источник данных | Тип обработки |
|------------------|-----------------|---------------|
| Номер поручения | `instruction_number` | Прямая подстановка |
| Дата агент-субагент | `agent_contract_date` | Русский формат даты |
| Дата поручения (RU) | `instruction_signed_date` | Русский формат |
| Дата поручения (EN) | `instruction_signed_date` | Английский формат |
| Агент (RU) | `agent_id.name` | Прямая подстановка |
| Агент (EN) | `agent_id.name` | Перевод через YandexGPT |
| Клиент (RU) | `client_id.name` | Прямая подстановка |
| Клиент (EN) | `client_id.name` | Перевод через YandexGPT |
| Покупатель/продавец | `exporter_importer_name` | Прямая подстановка |
| Адрес получателя | `beneficiary_address` | Прямая подстановка |
| Банк получателя | `beneficiary_bank_name` | Прямая подстановка |
| Адрес банка | `bank_address` | Прямая подстановка |
| SWIFT код | `bank_swift` | Прямая подстановка |
| Сумма | `amount` | Форматирование с 2 знаками |
| Валюта | `currency` | Верхний регистр |
| Курс | `rate_field` | Форматирование с 4 знаками |

## Логирование

Все операции логируются с префиксом для удобства отладки:
- `[ГЕНЕРАЦИЯ ДОКУМЕНТА ИНДИВИДУАЛ]` - основные операции
- `[ПЕРЕВОД]` - операции перевода через YandexGPT
- `[ДАННЫЕ ДЛЯ ШАБЛОНА ИНДИВИДУАЛ]` - подготовка данных

## Обработка ошибок

Система включает комплексную обработку ошибок:
- Проверка наличия шаблона в библиотеке
- Валидация настроек YandexGPT
- Обработка ошибок конвертации в PDF
- Fallback к оригинальному тексту при неудачном переводе

## См. также

- [Детали реализации](IMPLEMENTATION.md)
- [Сопоставление полей](FIELD_MAPPING.md)
- [Интеграция с YandexGPT](YANDEX_GPT_INTEGRATION.md)
- [Руководство пользователя](USER_GUIDE.md)
