# Автоматизация сопоставления заявок с выписками разнос

## Описание функциональности

Реализована автоматическая система сопоставления заявок с записями "выписка разнос" по критериям:
- **Плательщик**: плательщик и получатель выписки должны быть среди плательщиков заявки
- **Получатель**: получатель выписки должен быть среди плательщиков заявки  
- **Сумма**: сумма должна совпадать с допуском ±1 рубль

## Как это работает

### 1. Автоматическое сопоставление при создании

При создании новой записи "выписка разнос" автоматически:
- Ищутся подходящие заявки по критериям
- Если найдены подходящие заявки, они связываются с выпиской
- Устанавливается `direction_choice = 'applications'`
- Обновляется поле "Сделка" (`deal`)
- Устанавливается обратная связь в заявках

### 2. Критерии поиска заявок

- **Заявка должна быть взята в работу**: поле `taken_in_work_date` не пустое
- **Плательщики совпадают**: плательщик и получатель выписки должны быть среди плательщиков заявки (через `agent_id.payer_ids` и `client_id.payer_ids`)
- **Сумма совпадает**: проверяются поля заявки в порядке приоритета:
  1. `application_amount_rub_contract` (Заявка по курсу в рублях по договору)
  2. `total_fact` (Итого факт)
  3. `contract_reward` (Вознаграждение по договору)
- **Допуск по сумме**: ±1 рубль

### 3. Ручное сопоставление

Добавлена кнопка "Найти заявки" в форме выписки разнос для ручного запуска сопоставления:
- Работает только если еще нет связанных заявок
- Показывает результат в сообщениях (chatter)
- Логирует результаты

## Технические изменения

### 1. Модель `amanat.extract_delivery`

**Новые методы:**
- `_find_matching_applications()` - поиск подходящих заявок
- `manual_match_applications()` - ручное сопоставление (кнопка)

**Изменения в методах:**
- `create()` - добавлена автоматическая проверка и сопоставление при создании

### 2. Модель `amanat.extracts`

**Изменения в методах:**
- `_process_vypiska_attachments()` - убран дублирующий вызов `_run_matching_automation()`
- Добавлено сообщение об автоматическом сопоставлении

### 3. Представления

**Файл:** `views/extract_delivery_views.xml`
- Добавлена кнопка "Найти заявки" в header формы
- Добавлены поля `direction_choice` и `applications` на вкладку "Линки"

## Логирование

Все операции сопоставления логируются с уровнем INFO:
- Найденные совпадения
- Созданные связи
- Ошибки обработки

## Совместимость

- Существующие записи не затрагиваются
- Старый метод `_run_matching_automation()` сохранен для совместимости
- Можно использовать как автоматическое, так и ручное сопоставление

## Использование

1. **Автоматическое**: просто загрузите выписку через стандартный процесс
2. **Ручное**: откройте запись "выписка разнос" и нажмите кнопку "Найти заявки"
3. **Проверка**: результат отобразится в поле "Заявки" и "Сделка"

## Примеры логов

```
INFO: Найдено совпадение: выписка 123 (сумма 50000.0) с заявкой ZAY-001 (сумма 50000.0)
INFO: Автоматически связана выписка 123 с заявками: ['ZAY-001']
INFO: Ручное сопоставление: выписка 456 связана с заявками: ['ZAY-002', 'ZAY-003']
``` 