<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Правило для менеджеров -->
        <record id="amanat_transfer_manager_rule" model="ir.rule">
            <field name="name">Доступ к переводам менеджера</field>
            <field name="model_id" ref="model_amanat_transfer"/>
            <!-- <field name="domain_force">['|', ('manager_id', '=', user.id), ('manager_id', '=', False)]</field> -->
            <field name="domain_force">[('manager_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_manager'))]"/>
        </record>

        <!-- Правило для проверяющих -->
        <record id="amanat_transfer_inspector_rule" model="ir.rule">
            <field name="name">Доступ к переводам проверяющего</field>
            <field name="model_id" ref="model_amanat_transfer"/>
            <field name="domain_force">['|', ('inspector_id', '=', user.id), ('inspector_id', '=', False)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_inspector'))]"/>
        </record>

        <!-- Правило для старшего менеджера -->
        <record id="amanat_transfer_senior_rule" model="ir.rule">
            <field name="name">Старший менеджер видит все переводы</field>
            <field name="model_id" ref="model_amanat_transfer"/>
            <field name="domain_force">[]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_senior_manager'))]"/>
        </record>

        <!-- Правило чтения заявок для менеджера (включая закрытые) -->
        <record id="amanat_zayavka_manager_read_rule" model="ir.rule">
            <field name="name">Менеджер видит все заявки (ЭКСТРЕННО РАЗРЕШЕНО)</field>
            <field name="model_id" ref="model_amanat_zayavka"/>
            <field name="domain_force">[(1, '=', 1)] if user.name == 'Диляра' else [('manager_ids.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_manager'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="0"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="0"/>
        </record>

        <!-- Правило записи заявок для менеджера (только незакрытые) -->
        <record id="amanat_zayavka_manager_write_rule" model="ir.rule">
            <field name="name">Менеджер может редактировать заявки (ЭКСТРЕННО РАЗРЕШЕНО)</field>
            <field name="model_id" ref="model_amanat_zayavka"/>
            <field name="domain_force">[(1, '=', 1)] if user.name == 'Диляра' else [('manager_ids.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_manager'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

        <!-- Правило для старшего менеджера - видит все заявки -->
        <record id="amanat_zayavka_senior_manager_rule" model="ir.rule">
            <field name="name">Старший менеджер видит все заявки</field>
            <field name="model_id" ref="model_amanat_zayavka"/>
            <field name="domain_force">[]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_senior_manager'))]"/>
        </record>

        <!-- Правило для пользователей с доступом только к транзитным переводам -->
        <record id="amanat_transfer_transit_only_rule" model="ir.rule">
            <field name="name">Доступ только к транзитным переводам</field>
            <field name="model_id" ref="model_amanat_transfer"/>
            <field name="domain_force">[('is_transit', '=', True)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_transit_only'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="0"/>
            <field name="perm_unlink" eval="0"/>
        </record>

        <!-- Разрешить создание переводов для роли "Транзитные переводы" -->
        <record id="amanat_transfer_transit_only_create_rule" model="ir.rule">
            <field name="name">Создание переводов для транзитной роли</field>
            <field name="model_id" ref="model_amanat_transfer"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_transit_only'))]"/>
            <field name="perm_read" eval="0"/>
            <field name="perm_write" eval="0"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="0"/>
        </record>

        <!-- Правило для ордеров транзитных переводов -->
        <record id="amanat_order_transit_only_rule" model="ir.rule">
            <field name="name">Доступ только к ордерам транзитных переводов</field>
            <field name="model_id" ref="model_amanat_order"/>
            <field name="domain_force">[('transfer_id.is_transit', '=', True)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_transit_only'))]"/>
        </record>

        <!-- Правило для денежных контейнеров транзитных переводов -->
        <record id="amanat_money_transit_only_rule" model="ir.rule">
            <field name="name">Доступ только к денежным контейнерам транзитных переводов</field>
            <field name="model_id" ref="model_amanat_money"/>
            <field name="domain_force">[('order_id.transfer_id.is_transit', '=', True)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_transit_only'))]"/>
        </record>

        <!-- Правило для сверок транзитных переводов -->
        <record id="amanat_reconciliation_transit_only_rule" model="ir.rule">
            <field name="name">Доступ только к сверкам транзитных переводов</field>
            <field name="model_id" ref="model_amanat_reconciliation"/>
            <field name="domain_force">[('order_id.transfer_id.is_transit', '=', True)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_transit_only'))]"/>
        </record>

        <!-- Правило для SWIFT документов - обычные пользователи видят только свои документы -->
        <record id="amanat_swift_document_user_rule" model="ir.rule">
            <field name="name">Пользователи видят только свои SWIFT документы</field>
            <field name="model_id" ref="model_amanat_swift_document_upload"/>
            <field name="domain_force">[('manager_id.user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_manager')), (4, ref('amanat.group_amanat_inspector')), (4, ref('amanat.group_amanat_fin_manager')), (4, ref('amanat.group_amanat_fin_manager_jess')), (4, ref('amanat.group_amanat_treasurer')), (4, ref('amanat.group_amanat_transit_only'))]"/>
        </record>

        <!-- Правило для SWIFT документов - администраторы и старшие менеджеры видят все документы -->
        <record id="amanat_swift_document_admin_rule" model="ir.rule">
            <field name="name">Администраторы и старшие менеджеры видят все SWIFT документы</field>
            <field name="model_id" ref="model_amanat_swift_document_upload"/>
            <field name="domain_force">[]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_admin')), (4, ref('amanat.group_amanat_senior_manager')), (4, ref('amanat.group_amanat_director'))]"/>
        </record>

        <!-- Правила доступа к вложениям (ir.attachment) -->
        
        <!-- УЛУЧШЕННОЕ ГЛОБАЛЬНОЕ ПРАВИЛО: Отключаем все ограничения для amanat групп -->
        <record id="amanat_attachment_global_access" model="ir.rule">
            <field name="name">Amanat Global Attachment Access</field>
            <field name="model_id" ref="base.model_ir_attachment"/>
            <field name="domain_force">[]</field>
            <field name="global" eval="True"/>
            <field name="active" eval="True"/>
            <field name="groups" eval="[
                (4, ref('amanat.group_amanat_admin')), 
                (4, ref('amanat.group_amanat_director')), 
                (4, ref('amanat.group_amanat_senior_manager')),
                (4, ref('amanat.group_amanat_manager')), 
                (4, ref('amanat.group_amanat_inspector')), 
                (4, ref('amanat.group_amanat_fin_manager')), 
                (4, ref('amanat.group_amanat_fin_manager_jess')), 
                (4, ref('amanat.group_amanat_treasurer')), 
                (4, ref('amanat.group_amanat_transit_only')),
                (4, ref('amanat.group_amanat_alina_manager_files'))
            ]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

        <!-- ДОПОЛНИТЕЛЬНОЕ ПРАВИЛО: Доступ к файлам связанным с заявками для всех групп Amanat -->
        <record id="amanat_attachment_zayavka_access" model="ir.rule">
            <field name="name">Amanat Attachment Zayavka Access</field>
            <field name="model_id" ref="base.model_ir_attachment"/>
            <field name="domain_force">['|', '|', '|', 
                ('res_model', '=', 'amanat.zayavka'),
                ('res_model', '=', False),
                ('create_uid', '=', user.id),
                ('res_id', '=', False)
            ]</field>
            <field name="groups" eval="[
                (4, ref('amanat.group_amanat_admin')), 
                (4, ref('amanat.group_amanat_director')), 
                (4, ref('amanat.group_amanat_senior_manager')),
                (4, ref('amanat.group_amanat_manager')), 
                (4, ref('amanat.group_amanat_inspector')), 
                (4, ref('amanat.group_amanat_fin_manager')), 
                (4, ref('amanat.group_amanat_fin_manager_jess')), 
                (4, ref('amanat.group_amanat_treasurer')), 
                (4, ref('amanat.group_amanat_transit_only')),
                (4, ref('amanat.group_amanat_alina_manager_files'))
            ]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
            <field name="active" eval="True"/>
        </record>

        <!-- СПЕЦИАЛЬНОЕ ПРАВИЛО: Полный доступ к файлам для группы Алины -->
        <record id="amanat_attachment_alina_manager_access" model="ir.rule">
            <field name="name">Alina Manager Files Access</field>
            <field name="model_id" ref="base.model_ir_attachment"/>
            <field name="domain_force">[]</field>
            <field name="groups" eval="[(4, ref('amanat.group_amanat_alina_manager_files'))]"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
            <field name="global" eval="True"/>
            <field name="active" eval="True"/>
        </record>

    </data>
</odoo>