# YandexGPT API Интеграция для Odoo 18

## Описание

Этот модуль добавляет интеграцию с YandexGPT API в систему Amanat для анализа заявок на переводы.

## Основные функции

### 1. Настройка API
- Настройка IAM токена и Folder ID через интерфейс администратора
- Безопасное хранение токенов в системных параметрах
- Автоматическая проверка конфигурации при использовании

### 2. Анализ заявок
- Автоматическое формирование сообщения для анализа на основе данных заявки
- Гибкие параметры анализа (температура, количество токенов, тип модели)
- Запись результатов анализа в чаттер заявки

### 3. Интерфейс пользователя
- Кнопка "YandexGPT Анализ" в форме заявки
- Уведомления об успешном выполнении или ошибках
- Доступ только для администраторов и старших менеджеров

## Установка и настройка

### 1. Настройка YandexGPT API

1. Перейдите в **Настройки** → **Общие настройки**
2. Найдите раздел **YandexGPT API Configuration**
3. Введите:
   - **YandexGPT IAM Token**: Ваш IAM токен от Yandex Cloud
   - **YandexGPT Folder ID**: ID папки в Yandex Cloud

### 2. Получение токенов Yandex Cloud

1. Зарегистрируйтесь в [Yandex Cloud](https://cloud.yandex.ru/)
2. Создайте сервисный аккаунт
3. Получите IAM токен
4. Создайте папку и получите ее ID

## Использование

### Через интерфейс
1. Откройте любую заявку
2. Нажмите кнопку **"YandexGPT Анализ"** в заголовке формы
3. Результат анализа появится в чаттере заявки

### Программное использование

```python
# В методе модели amanat.zayavka
def analyze_application(self):
    result = self.yandex_gpt_analyse(
        user_message="Проанализируй эту заявку на предмет рисков",
        system_message="Ты финансовый аналитик. Дай краткий анализ.",
        temperature=0.3,
        max_tokens=1000
    )
    
    if result['success']:
        return result['response']
    else:
        raise UserError(result['error'])
```

## Параметры API

### `yandex_gpt_analyse()`

- **user_message** (str): Сообщение для анализа
- **system_message** (str, optional): Системное сообщение с инструкциями
- **model_type** (str, optional): Тип модели ('latest', 'rc', 'pro', 'lite')
- **temperature** (float, optional): Температура генерации (0.0-1.0)
- **max_tokens** (int, optional): Максимальное количество токенов в ответе

### Возвращаемое значение

```python
{
    'success': bool,
    'response': str,  # Текст ответа (если success=True)
    'error': str,     # Описание ошибки (если success=False)
    'full_result': dict  # Полный ответ API
}
```

## Безопасность

- IAM токены хранятся в зашифрованном виде
- Доступ к функции анализа ограничен группами пользователей
- Все запросы логируются для аудита
- Таймаут запросов ограничен 30 секундами

## Логирование

Все операции логируются с использованием стандартного логгера Odoo:
- Отправка запросов к API
- Получение ответов
- Ошибки соединения и API

## Обработка ошибок

- Проверка конфигурации перед запросом
- Обработка ошибок сети и таймаутов
- Валидация ответов API
- Понятные сообщения об ошибках для пользователей

## Файлы модуля

- `models/zayavka/automations/ygpt_analyse.py` - Основная логика интеграции
- `models/res_config_settings.py` - Настройки конфигурации
- `views/res_config_settings.xml` - Интерфейс настроек
- `views/zayavka_views.xml` - Кнопка анализа в форме заявки

## Требования

- Odoo 18.0+
- Python библиотека `requests`
- Активный аккаунт Yandex Cloud
- Доступ к YandexGPT API

## Поддержка

При возникновении проблем проверьте:
1. Правильность IAM токена и Folder ID
2. Доступность интернет-соединения
3. Логи Odoo для подробной информации об ошибках