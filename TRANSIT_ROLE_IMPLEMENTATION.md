# Реализация роли с доступом к транзитным переводам

## Что было реализовано

### 1. Новое поле "Транзит" в модели Transfer
- Добавлено булево поле `is_transit` в модель `amanat.transfer`
- Поле отслеживает изменения (tracking=True)
- Поле добавлено в список полей для real-time обновлений

### 2. Новая группа безопасности
- Создана группа `group_amanat_transit_only` с названием "Транзитные переводы"
- Группа предназначена для пользователей, которым нужен доступ только к переводам с галочкой "Транзит"

### 3. Правила доступа к данным
Созданы правила доступа для ограничения видимости данных:
- `amanat_transfer_transit_only_rule` - доступ только к переводам с флагом "Транзит"
- `amanat_order_transit_only_rule` - доступ только к ордерам транзитных переводов
- `amanat_money_transit_only_rule` - доступ только к денежным контейнерам транзитных переводов
- `amanat_reconciliation_transit_only_rule` - доступ только к сверкам транзитных переводов

### 4. Права доступа к моделям
Добавлены права доступа для новой группы к следующим моделям:
- `amanat.transfer` - чтение, запись, создание (без удаления)
- `amanat.order` - чтение, запись, создание (без удаления)
- `amanat.money` - чтение, запись, создание (без удаления)
- `amanat.reconciliation` - чтение, запись, создание (без удаления)
- `amanat.contragent` - только чтение
- `amanat.payer` - только чтение  
- `amanat.wallet` - только чтение

### 5. Обновленные представления
- Добавлено поле "Транзит" в список переводов (`transfer_list_view`)
- Добавлено поле "Транзит" в форму перевода (`transfer_form_view`) на вкладке "Сложные переводы"

### 6. Настройка меню
Добавлен доступ к разделу "Перевод" и всем его подменю для группы "Транзитные переводы":
- Группа "Перевод" (основное меню)
- Переводы
- Ордеры  
- Денежные контейнеры
- Сверки

Все остальные разделы меню скрыты для данной роли.

## Как использовать

### Для администратора:
1. Назначьте пользователю группу "Транзитные переводы" через настройки пользователя
2. Пользователь получит доступ только к переводам с установленной галочкой "Транзит"

**Комбинированные роли:**
- **Только "Транзитные переводы"**: Минимальное меню - только раздел "Валютные операции" → "Перевод"
- **"Менеджер" + "Транзитные переводы"**: Расширенное меню - переводы + справочники + заявки + калькуляторы
- **Обычный "Менеджер"**: Стандартное меню менеджера БЕЗ переводов

### Для пользователя:
1. В списке переводов и форме перевода появится поле "Транзит"
2. При создании нового перевода галочка "Транзит" устанавливается автоматически для пользователей с ролью "Транзитные переводы"
3. Установка галочки "Транзит" делает перевод видимым для роли "Транзитные переводы"

## Файлы, которые были изменены:
- `models/transfer/transfer.py` - добавлено поле is_transit
- `models/res_users.py` - добавлена проверка группы is_transit_only в check_user_groups
- `static/src/webclient/appsbar/appsbar.js` - настройка фильтрации меню для роли
- `views/transfer_views.xml` - добавлено поле в представления
- `views/menu.xml` - настройка видимости меню для новой роли
- `security/security_groups.xml` - новая группа безопасности
- `security/record_rules.xml` - правила доступа к данным
- `security/ir.model.access.csv` - права доступа к моделям

## Безопасность
- Пользователи с ролью "Транзитные переводы" видят ТОЛЬКО переводы с галочкой "Транзит"
- У них есть права на чтение, запись и создание переводов, ордеров, денежных контейнеров и сверок, но не на удаление
- Доступ к связанным справочникам (контрагенты, плательщики, кошельки) только на чтение
- Все связанные данные (ордера, денежные контейнеры, сверки) также фильтруются по принципу транзитности

## Исправления
**v1.1 - Исправлена ошибка доступа к ордерам:**
- Обновлены права доступа для `amanat.order` с (1,0,0,0) на (1,1,1,0)
- Добавлены права доступа и правила для `amanat.money` и `amanat.reconciliation`
- Добавлены record rules для всех связанных моделей для корректной фильтрации данных

**v1.2 - Настройка видимости меню:**
- Добавлен доступ к группе меню "Перевод" для роли "Транзитные переводы"
- Настроен доступ ко всем подменю: Переводы, Ордеры, Денежные контейнеры, Сверки
- Все остальные разделы меню остаются скрытыми для данной роли

**v1.3 - Интеграция с JavaScript фильтрацией меню:**
- Добавлена проверка группы `is_transit_only` в метод `check_user_groups` (res_users.py)
- Обновлена фильтрация меню в appsbar.js для корректного отображения только раздела "Перевод"
- Правильное название проверки группы: `is_transit_only` (соответствует XML ID: `group_amanat_transit_only`)

**v1.4 - Исправление проблемы с созданием переводов:**
- Разделены правила доступа на отдельные операции (чтение/запись и создание)
- Добавлено правило `amanat_transfer_transit_only_create_rule` для разрешения создания переводов
- Теперь пользователи с ролью "Транзитные переводы" могут создавать новые переводы и устанавливать на них галочку "Транзит"

**v1.5 - Автоматическая установка галочки "Транзит":**
- Добавлен метод `default_get()` для автоматической установки галочки "Транзит" при открытии формы создания перевода
- Добавлена проверка в методе `create()` для гарантированной установки флага при создании
- Теперь пользователи с ролью "Транзитные переводы" при создании нового перевода автоматически получают установленную галочку "Транзит"

**v1.6 - Комбинированные роли в JavaScript меню:**
- Добавлена поддержка комбинированных ролей в `appsbar.js`
- Если пользователь имеет роли "Менеджер" + "Транзитные переводы": показывается расширенное меню (Переводы + все что видит менеджер)
- Если пользователь имеет только роль "Транзитные переводы": показывается минимальное меню (только Переводы)
- Обычные менеджеры (без роли "Транзитные переводы") не видят раздел "Переводы"