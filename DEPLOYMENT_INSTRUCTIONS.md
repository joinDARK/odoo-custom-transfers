# Инструкция по развертыванию обновлений модуля Amanat

## Изменения в модуле

### Обновленные файлы
1. `addons/amanat/models/reconciliation.py` - обновлен метод `_run_reconciliation_export()`
2. `addons/amanat/models/sverka_files.py` - добавлены новые поля и методы
3. `addons/amanat/views/sverka_files_views.xml` - обновлены представления
4. `addons/amanat/docs/models/sverka_files.md` - обновлена документация

### Новые файлы
1. `addons/amanat/README_NEW_SVERKA_API.md` - документация по новой API
2. `addons/amanat/DEPLOYMENT_INSTRUCTIONS.md` - этот файл

## Последовательность развертывания

### 1. Остановка сервера Odoo
```bash
sudo systemctl stop odoo
```

### 2. Создание резервной копии базы данных
```bash
pg_dump -U odoo -h localhost odoo_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 3. Обновление модуля
```bash
cd /home/incube/Documents/odoo
./odoo-bin -d odoo_db -u amanat --stop-after-init
```

### 4. Проверка логов
Проверьте логи на наличие ошибок:
```bash
tail -f /var/log/odoo/odoo.log
```

### 5. Запуск сервера
```bash
sudo systemctl start odoo
```

## Проверка работоспособности

### 1. Проверка доступности интерфейса
- Откройте браузер и перейдите к системе
- Войдите в систему
- Проверьте, что модуль загрузился без ошибок

### 2. Проверка новых полей
- Перейдите в **Сверка файлы**
- Убедитесь, что новые поля отображаются:
  - Основных файлов
  - Тестовых файлов
  - Всего файлов

### 3. Проверка кнопок
- Проверьте наличие новых кнопок в списке:
  - Скачать основные файлы (зеленая)
  - Скачать тестовые файлы (желтая)
- Проверьте кнопки в форме

### 4. Тестирование функциональности
- Создайте тестовую сверку
- Нажмите "Выгрузить в Excel"
- Проверьте, что создались 2 файла

## Откат изменений (при необходимости)

### 1. Восстановление из резервной копии
```bash
sudo systemctl stop odoo
dropdb -U postgres odoo_db
createdb -U postgres odoo_db
psql -U postgres odoo_db < backup_YYYYMMDD_HHMMSS.sql
```

### 2. Восстановление старых файлов
```bash
git checkout HEAD~1 -- addons/amanat/models/reconciliation.py
git checkout HEAD~1 -- addons/amanat/models/sverka_files.py
git checkout HEAD~1 -- addons/amanat/views/sverka_files_views.xml
```

### 3. Запуск сервера
```bash
sudo systemctl start odoo
```

## Возможные проблемы

### Проблема: Ошибка при обновлении модуля
**Решение:** Проверить логи, исправить синтаксические ошибки, повторить обновление

### Проблема: Поля не отображаются
**Решение:** Принудительно обновить представления:
```bash
./odoo-bin -d odoo_db -u amanat -i amanat --stop-after-init
```

### Проблема: Сервер API недоступен
**Решение:** Проверить доступность сервера на порту 8085:
```bash
curl -X GET http://localhost:8085/api/health
```

### Проблема: Ошибки прав доступа
**Решение:** Проверить права на файлы:
```bash
sudo chown -R odoo:odoo /home/incube/Documents/odoo/addons/amanat
```

## Мониторинг

### Логи для отслеживания
- `/var/log/odoo/odoo.log` - основные логи Odoo
- Логи успешного создания файлов: "Успешно созданы файлы сверки"
- Логи ошибок: "Ошибка при отправке данных на сервер"

### Метрики для мониторинга
- Время отклика API сервера
- Количество успешных/неуспешных запросов
- Размер создаваемых файлов

## Контакты

При возникновении проблем обращайтесь к:
- Системному администратору
- Разработчикам модуля
- Команде поддержки Odoo

## Чеклист развертывания

- [ ] Резервная копия создана
- [ ] Сервер остановлен
- [ ] Модуль обновлен
- [ ] Логи проверены
- [ ] Сервер запущен
- [ ] Интерфейс доступен
- [ ] Новые поля отображаются
- [ ] Кнопки работают
- [ ] Тестовая сверка создана
- [ ] Два файла сгенерированы
- [ ] Команда уведомлена об обновлении 